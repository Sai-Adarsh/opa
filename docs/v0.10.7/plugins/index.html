<!doctype html><html lang=en><head><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-84550302-1','auto');ga('send','pageview');</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=description content="Policy-based control for cloud native environments"><meta property=og:title content="Plugins (Experimental)"><meta property=og:type content=documentation><meta property=og:url content=https://openpolicyagent.org/docs/v0.10.7/plugins/><meta property=og:locale content=en_US><meta property=og:site_name content="Open Policy Agent"><meta property=og:description content="Policy-based control for cloud native environments"><meta name=og:type content=article><meta name=og:image content=https://openpolicyagent.org/img/logos/opa-horizontal-color.png><meta name=og:image:alt content="Open Policy Agent project logo"><meta name=og:image:type content=image/png><meta name=twitter:card content=summary><meta name=twitter:site content=@OpenPolicyAgent><meta name=twitter:creator content=@OpenPolicyAgent><link rel=canonical content=https://openpolicyagent.org/docs/v0.10.7/plugins/><link rel="shortcut icon" href=/favicon.png type=image/x-icon><meta name=generator content="Hugo 0.53"><title>Open Policy Agent | Plugins (Experimental)</title><link rel=stylesheet href=/css/style.6bbca25e01250b8412df90aabdfbddb4f7b3b892dd593d933cd29794b98a3373.css integrity="sha256-a7yiXgElC4QS35CqvfvdtPezuJLdWT2TPNKXlLmKM3M="></head><body><div class=dashboard><div class="dashboard-panel left has-background-white-bis is-hidden-mobile"><div class="dashboard-panel-header has-text-centered"><div class=dashboard-panel-header-logo><a href=https://openpolicyagent.org><img src=/img/logos/opa-stacked-color.png></a></div><div class="dropdown is-left"><div class=dropdown-trigger><span class="button is-primary"><span><strong>v0.10.7</strong>
<span class="tag latest-tag is-success is-small has-text-weight-bold">latest</span></span></span></div></div></div><div class="dashboard-panel-content is-scrollable"><div class=docs-nav><span class=docs-nav-title>Documentation</span>
<a class=docs-nav-item href=/docs/v0.10.7/>Introduction</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=docs-nav-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=docs-nav-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=docs-nav-item href=/docs/v0.10.7/status/>Status</a>
<a class=docs-nav-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=docs-nav-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=docs-nav-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=docs-nav-item href=/docs/v0.10.7/security/>Security</a>
<a class="docs-nav-item is-active" href=/docs/v0.10.7/plugins/>Plugins</a><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#building-go-plugins>Building Go Plugins</a></li><li><a href=#built-in-functions>Built-in Functions</a></li><li><a href=#custom-plugins>Custom Plugins</a><ul><li><a href=#putting-it-together>Putting It Together</a></li></ul></li></ul></li></ul></nav></div><a class=docs-nav-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=docs-nav-item href=/docs/v0.10.7/faq/>FAQ</a>
<a class=docs-nav-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><hr class=docs-nav-hr><span class=docs-nav-title>Tutorials</span>
<a class=docs-nav-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=docs-nav-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=docs-nav-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=docs-nav-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><hr class=docs-nav-hr><span class=docs-nav-title>Guides</span>
<a class=docs-nav-item href=/docs/v0.10.7/guides-identity/>Identity and User Attributes</a>
<a class=docs-nav-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Kubernetes Admission Control</a></div></div></div><div class="dashboard-main is-scrollable"><nav class="navbar is-primary"><div class="navbar-brand is-hidden-tablet"><a class=navbar-item href=https://openpolicyagent.org><img src=/img/logos/opa-icon-white.png></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=mobile-menu><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div class="navbar-menu is-hidden-tablet" id=mobile-menu><div class=navbar-start><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Documentation</span>
<a class=navbar-item href=/docs/v0.10.7/>Introduction</a>
<a class=navbar-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=navbar-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=navbar-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=navbar-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=navbar-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=navbar-item href=/docs/v0.10.7/status/>Status</a>
<a class=navbar-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=navbar-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=navbar-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=navbar-item href=/docs/v0.10.7/security/>Security</a>
<a class=navbar-item href=/docs/v0.10.7/plugins/>Plugins (Experimental)</a>
<a class=navbar-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=navbar-item href=/docs/v0.10.7/faq/>Frequently Asked Questions</a>
<a class=navbar-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Tutorials</span>
<a class=navbar-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=navbar-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=navbar-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=navbar-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Guides</span>
<a class=navbar-item href=/docs/v0.10.7/guides-identity/>Guides: Identity and User Attributes</a>
<a class=navbar-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Guides: Kubernetes Admission Control</a></div><div class=navbar-end><div class=navbar-item><div class=buttons><a class="button is-primary" href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class="button is-primary" href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class="button is-primary" href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class="button is-primary" href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></div></div><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class=navbar-item href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class=navbar-item href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class=navbar-item href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></nav><article class=article><div class=container><section class=hero><div class=hero-body><p class="title is-size-1 is-size-2-mobile">Plugins (Experimental)</p></div></section><section class=section><div class=content><p>OPA can be extended with custom built-in functions and plugins that
implement functionality like support for new protocols.</p><blockquote><p>This page focuses on how to build <a href=https://golang.org/pkg/plugin/>Go
plugins</a> that can be loaded when OPA
starts however the steps are similar if you are embedding OPA as a
library or building from source.</p></blockquote><h2 id=building-go-plugins>Building Go Plugins</h2><p>At minimum, your Go plugin must implement the following:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// your init function
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span></code></pre></div><p>When OPA starts, it will invoke the <code>Init</code> function which can:</p><ul><li>Register custom built-in functions.</li><li>Register custom OPA plugins (e.g., decision loggers, servers, etc.)</li><li>&hellip;or do anything else.</li></ul><p>See the sections below for examples.</p><p>To build your plugin into a shared object file (<code>.so</code>), you will
(minimally) run the following command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>go build -buildmode<span style=color:#ce5c00;font-weight:700>=</span>plugin -o<span style=color:#ce5c00;font-weight:700>=</span>plugin.so plugin.go</code></pre></div><p>This will produce a file named <code>plugin.so</code> that you can pass to OPA
with the <code>--plugin-dir</code> flag. OPA will load all of the <code>.so</code> files out
of the directory you give it.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>opa --plugin-dir<span style=color:#ce5c00;font-weight:700>=</span>/path/to/plugins run</code></pre></div><p><strong>NOTE:</strong> You must build your plugin against the same version of the
OPA that will eventually load the shared object file. If you build
your plugin against a different version of the OPA source, the OPA
will fail to start. You will see an error message like:</p><pre><code>Error: plugin.Open(&quot;plugin/logger&quot;): plugin was built with a different version of package github.com/open-policy-agent/opa/ast
</code></pre><h2 id=built-in-functions>Built-in Functions</h2><p>To implement custom built-in functions your <code>Init</code> function should call:</p><ul><li><code>ast.RegisterBuiltin</code> to declare the built-in function.</li><li><code>topdown.RegisterFunctionalBuiltin[X]</code> to register the built-in function implementation (where X is replaced by the number of parameters your function receives.)</li></ul><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;github.com/open-policy-agent/opa/ast&#34;</span>
	<span style=color:#4e9a06>&#34;github.com/open-policy-agent/opa/types&#34;</span>
	<span style=color:#4e9a06>&#34;github.com/open-policy-agent/opa/topdown&#34;</span>
	<span style=color:#4e9a06>&#34;github.com/open-policy-agent/opa/topdown/builtins&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>HelloBuiltin</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>ast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Builtin</span><span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Name</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#000>Decl</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewFunction</span><span style=color:#000;font-weight:700>(</span>
		<span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Args</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>S</span><span style=color:#000;font-weight:700>),</span>
		<span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>S</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#000;font-weight:700>),</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>HelloImpl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>a</span> <span style=color:#000>ast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>ast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Value</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>s</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>builtins</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StringOperand</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>String</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello, &#34;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#204a87>string</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>)),</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>ast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RegisterBuiltin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloBuiltin</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>topdown</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RegisterFunctionalBuiltin1</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HelloBuiltin</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>HelloImpl</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>If you build this file into a shared object and start OPA with it you can call it like other built-in functions:</p><pre><code>&gt; hello(&quot;bob&quot;)
&quot;hello, bob&quot;
</code></pre><p>For more details on implementing built-in functions, see the <a href=https://godoc.org/github.com/open-policy-agent/opa/topdown#example-RegisterFunctionalBuiltin1>OPA Go Documentation</a>.</p><h2 id=custom-plugins>Custom Plugins</h2><p>OPA defines a plugin interface that allows you to customize certain
behaviour like decision logging or add new behaviour like different
query APIs. To implement a custom plugin you must implement two
interfaces:</p><ul><li><a href=https://godoc.org/github.com/open-policy-agent/opa/plugins#Factory>github.com/open-policy-agent/opa/plugins#Factory</a> to instantiate your plugin.</li><li><a href=https://godoc.org/github.com/open-policy-agent/opa/plugins#Plugin>github.com/open-policy-agent/opa/plugins#Plugin</a> to provide your plugin behavior.</li></ul><p>You can register your factory with OPA by calling <a href=https://godoc.org/github.com/open-policy-agent/opa/runtime#RegisterPlugin>github.com/open-policy-agent/opa/runtime#RegisterPlugin</a> inside your <code>Init</code> function.</p><h3 id=putting-it-together>Putting It Together</h3><p>The example below shows how you can implement a custom <a href=../decision-logs>Decision Logger</a>
that writes events to a stream (e.g., stdout/stderr).</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Config</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Stderr</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#4e9a06>`json:&#34;stderr&#34;`</span> <span style=color:#8f5902;font-style:italic>// false =&gt; stdout, true =&gt; stderr
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>PrintlnLogger</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>mtx</span> <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Mutex</span>
	<span style=color:#000>config</span> <span style=color:#000>Config</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>PrintlnLogger</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Start</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// No-op.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>PrintlnLogger</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Stop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// No-op.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>PrintlnLogger</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Reconfigure</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>config</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mtx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mtx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>config</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>.(</span><span style=color:#000>Config</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>PrintlnLogger</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Log</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>event</span> <span style=color:#000>logs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>EventV1</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mtx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mtx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stdout</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>w</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fprintln</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>event</span><span style=color:#000;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// ignoring errors!
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Next, implement a factory function that instantiates your plugin:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Factory</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>Factory</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>plugins</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Manager</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>config</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#000>plugins</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Plugin</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>PrintlnLogger</span><span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>config</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>config</span><span style=color:#000;font-weight:700>.(</span><span style=color:#000>Config</span><span style=color:#000;font-weight:700>),</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>Factory</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Validate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>plugins</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Manager</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>config</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>parsedConfig</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>Config</span><span style=color:#000;font-weight:700>{}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>parsedConfig</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>util</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unmarshal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>parsedConfig</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Finally, register your factory with OPA:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RegisterPlugin</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;println_decision_logger&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Factory</span><span style=color:#000;font-weight:700>{})</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>To test your plugin, build a shared object file:</p><pre><code>go build -buildmode=plugin -o=plugin.so main.go
</code></pre><p>Define an OPA configuration file that will use your plugin:</p><p><strong>config.yaml</strong>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>decision_logs<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>plugin<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>println_decision_logger<span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>plugins<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>println_decision_logger<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>stderr<span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span></code></pre></div><p>Start OPA with the plugin directory and configuration file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>opa --plugin-dir <span style=color:#000>$PWD</span> run --server --config-file config.yaml</code></pre></div><p>Exercise the plugin via the OPA API:</p><pre><code>curl localhost:8181/v1/data
</code></pre><p>If everything worked you will see the Go struct representation of the decision
log event written to stdout.</p><p>The source code for this example can be found <a href=https://github.com/open-policy-agent/contrib/tree/master/decision_logger_plugin_example>here</a>.</p></div></section></div></article></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js></script><script src=/js/app.145c7a3bc61d0b561cc282851776ffdcd33e6b35aebca1b05449aa9195eaf751.js integrity="sha256-FFx6O8YdC1YcwoKFF3b/3NM&#43;azWuvKGwVEmqkZXq91E="></script></body></html>