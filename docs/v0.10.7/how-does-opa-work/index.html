<!doctype html><html lang=en><head><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-84550302-1','auto');ga('send','pageview');</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=description content="Policy-based control for cloud native environments"><meta property=og:title content="How Does OPA Work?"><meta property=og:type content=documentation><meta property=og:url content=https://openpolicyagent.org/docs/v0.10.7/how-does-opa-work/><meta property=og:locale content=en_US><meta property=og:site_name content="Open Policy Agent"><meta property=og:description content="Policy-based control for cloud native environments"><meta name=og:type content=article><meta name=og:image content=https://openpolicyagent.org/img/logos/opa-horizontal-color.png><meta name=og:image:alt content="Open Policy Agent project logo"><meta name=og:image:type content=image/png><meta name=twitter:card content=summary><meta name=twitter:site content=@OpenPolicyAgent><meta name=twitter:creator content=@OpenPolicyAgent><link rel=canonical content=https://openpolicyagent.org/docs/v0.10.7/how-does-opa-work/><link rel="shortcut icon" href=/favicon.png type=image/x-icon><meta name=generator content="Hugo 0.53"><title>Open Policy Agent | How Does OPA Work?</title><link rel=stylesheet href=/css/style.6bbca25e01250b8412df90aabdfbddb4f7b3b892dd593d933cd29794b98a3373.css integrity="sha256-a7yiXgElC4QS35CqvfvdtPezuJLdWT2TPNKXlLmKM3M="></head><body><div class=dashboard><div class="dashboard-panel left has-background-white-bis is-hidden-mobile"><div class="dashboard-panel-header has-text-centered"><div class=dashboard-panel-header-logo><a href=https://openpolicyagent.org><img src=/img/logos/opa-stacked-color.png></a></div><div class="dropdown is-left"><div class=dropdown-trigger><span class="button is-primary"><span><strong>v0.10.7</strong>
<span class="tag latest-tag is-success is-small has-text-weight-bold">latest</span></span></span></div></div></div><div class="dashboard-panel-content is-scrollable"><div class=docs-nav><span class=docs-nav-title>Documentation</span>
<a class=docs-nav-item href=/docs/v0.10.7/>Introduction</a>
<a class="docs-nav-item is-active" href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#overview>Overview</a></li><li><a href=#deployment>Deployment</a></li><li><a href=#data-and-policies>Data and Policies</a><ul><li><a href=#base-documents>Base Documents</a></li><li><a href=#policies>Policies</a></li><li><a href=#rules-and-virtual-documents>Rules and Virtual Documents</a></li><li><a href=#the-data-document>The <code>data</code> Document</a></li><li><a href=#the-input-document>The <code>input</code> Document</a></li></ul></li><li><a href=#putting-it-all-together>Putting It All Together</a></li></ul></li></ul></nav></div><a class=docs-nav-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=docs-nav-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=docs-nav-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=docs-nav-item href=/docs/v0.10.7/status/>Status</a>
<a class=docs-nav-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=docs-nav-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=docs-nav-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=docs-nav-item href=/docs/v0.10.7/security/>Security</a>
<a class=docs-nav-item href=/docs/v0.10.7/plugins/>Plugins</a>
<a class=docs-nav-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=docs-nav-item href=/docs/v0.10.7/faq/>FAQ</a>
<a class=docs-nav-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><hr class=docs-nav-hr><span class=docs-nav-title>Tutorials</span>
<a class=docs-nav-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=docs-nav-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=docs-nav-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=docs-nav-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><hr class=docs-nav-hr><span class=docs-nav-title>Guides</span>
<a class=docs-nav-item href=/docs/v0.10.7/guides-identity/>Identity and User Attributes</a>
<a class=docs-nav-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Kubernetes Admission Control</a></div></div></div><div class="dashboard-main is-scrollable"><nav class="navbar is-primary"><div class="navbar-brand is-hidden-tablet"><a class=navbar-item href=https://openpolicyagent.org><img src=/img/logos/opa-icon-white.png></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=mobile-menu><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div class="navbar-menu is-hidden-tablet" id=mobile-menu><div class=navbar-start><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Documentation</span>
<a class=navbar-item href=/docs/v0.10.7/>Introduction</a>
<a class=navbar-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=navbar-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=navbar-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=navbar-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=navbar-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=navbar-item href=/docs/v0.10.7/status/>Status</a>
<a class=navbar-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=navbar-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=navbar-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=navbar-item href=/docs/v0.10.7/security/>Security</a>
<a class=navbar-item href=/docs/v0.10.7/plugins/>Plugins (Experimental)</a>
<a class=navbar-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=navbar-item href=/docs/v0.10.7/faq/>Frequently Asked Questions</a>
<a class=navbar-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Tutorials</span>
<a class=navbar-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=navbar-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=navbar-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=navbar-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Guides</span>
<a class=navbar-item href=/docs/v0.10.7/guides-identity/>Guides: Identity and User Attributes</a>
<a class=navbar-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Guides: Kubernetes Admission Control</a></div><div class=navbar-end><div class=navbar-item><div class=buttons><a class="button is-primary" href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class="button is-primary" href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class="button is-primary" href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class="button is-primary" href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></div></div><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class=navbar-item href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class=navbar-item href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class=navbar-item href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></nav><article class=article><div class=container><section class=hero><div class=hero-body><p class="title is-size-1 is-size-2-mobile">How Does OPA Work?</p></div></section><section class=section><div class=content><p>OPA is a full-featured policy engine that offloads policy decisions from your service. You can think of it as a concierge for your service who can answer detailed questions on behalf of your users to meet their specific needs.</p><h2 id=overview>Overview</h2><p>OPA’s RESTful APIs use JSON over HTTP so you and your users can integrate OPA with any programming language. At a high level, integrating OPA into your service involves:</p><ul><li>Deploying OPA alongside your service</li><li>Pushing relevant data about your service’s state into OPA’s document store</li><li>Offloading some or all decision-making to OPA by querying it</li></ul><p>When your service is integrated with OPA, your users will be able author and deploy custom policies that control the behavior of your service’s policy-enabled features. Furthermore, users can publish data to OPA that is not available to your service about their own deployment context.</p><figure class=figure><img src=/img/request-response.svg width=50%><figcaption class=has-text-weight-light>OPA&rsquo;s query and decision model</figcaption></figure><p>In the future, both your service and its users will be able to register for, and react to, notifications triggered when OPA detects a policy-relevant change.</p><h2 id=deployment>Deployment</h2><p>Unless you embed OPA as a Go library, you will deploy it alongside your service – either directly as an operating system daemon or inside a container. In this way, transactions will have low latency and availability will be determined through shared fate with your service.</p><p>When OPA starts for the first time, it will not contain any policies or data. Policies and data can be added, removed, and modified at any time. For example: by deployment automation software or your service as it is deployed, by your service during an upgrade, or by administrators as needed.</p><h2 id=data-and-policies>Data and Policies</h2><p>The primary unit of data in OPA is a document, which is similar to a JSON value. Documents typically correspond to single, self-contained objects and are capable of representing both primitive types (strings, numbers, booleans, and null) as well as structured types (objects, and arrays). Documents are created, read, updated, and deleted via OPA’s <a href=../rest-api>RESTful HTTP APIs</a>.</p><figure class=figure><img src=/img/data-model-dependencies.svg width=70%><figcaption class=has-text-weight-light>OPA data model dependencies</figcaption></figure><h3 id=base-documents>Base Documents</h3><p>So-called base documents contain static, structured data stored in memory and optionally saved to disk for resiliency. Your service will publish and update base documents in order to describe its current state, and your users can do the same to include relevant data about the state of their own deployment context.</p><p>Base documents are published and updated using OPA’s Data API. For example, the following request publishes a list of servers to OPA:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>PATCH</span> <span style=color:#000>https://example.com/v1/data/servers</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span>
<span style=color:#000>Content-Type</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>application/json-patch+json</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>[</span>
  <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;op&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;value&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;http&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;ssh&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p2&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;op&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;value&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;db&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;mysql&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;op&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;value&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s3&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;memcache&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>},</span>
  <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;op&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;add&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#204a87;font-weight:700>&#34;value&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s4&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;http&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;ssh&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p2&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>]</span></code></pre></div><h3 id=policies>Policies</h3><p>Policies are written using OPA’s purpose-built, declarative language Rego. Rego includes rich support for traversing nested documents and transforming data using syntax inspired by dictionary and array access in languages like Python and JSONPath. For detailed information about using Rego, see <a href=../how-do-i-write-policies>How Do I Write Policies?</a>.</p><p>Each Rego file defines a policy module using a collection of rules that describe the expected state of your service. Both your service and its users can publish and update policy modules using OPA’s Policy API. For example, the following request creates a policy with two rules (violations and public_servers) named “exempli-gratia”:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>PUT</span> <span style=color:#000>https://example.com/v1/policies/exempli-gratia</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span>
<span style=color:#000>Content-Type</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>text/plain</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span>

<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>networks</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ports</span>

<span style=color:#000>violations</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protocols</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;http&#34;</span>
    <span style=color:#000>public_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>public_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ports</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>ports</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>id</span>
    <span style=color:#000>ports</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>networks</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>networks</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>id</span>
    <span style=color:#000>networks</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>public</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>true</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>A policy file must contain a single package declaration, which defines the path to the policy module and its rules (for example, data.opa.examples.violations – see The data Document for more information about accessing nested documents). The policy name itself (in this case, “exempli-gratia”) is only used to identify policies for file management purposes; it is not used otherwise.</p><h3 id=rules-and-virtual-documents>Rules and Virtual Documents</h3><p>In contrast to base documents, virtual documents embody the results of evaluating the rules included in policy modules. Virtual documents are computed when users publish new policy modules, update existing modules, run queries, and when any relevant base document is published or updated. Rules allow policy authors to write questions with yes-no answers (that is, predicates) and to generate structured values from raw data found in base documents as well as from intermediate data found in other virtual documents.</p><h3 id=the-data-document>The <code>data</code> Document</h3><p>All documents pushed into OPA or computed by rules are nested under a built-in root document named data.</p><figure class=figure><img src=/img/data-model-logical.svg width=70%><figcaption class=has-text-weight-light>OPA document structure</figcaption></figure><p>Example <code>data</code> document:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;networks&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;opa&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;examples&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;violations&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;public_servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>As a result, any document, base or virtual, can be accessed hierarchically starting from the root data node – either as an identifier:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span>                            <span style=color:#8f5902;font-style:italic># Base document</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>violations</span>            <span style=color:#8f5902;font-style:italic># Virtual document</span></code></pre></div><p>or as a URI component in an HTTP request:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>https://example.com/v1/data/servers</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>https://example.com/v1/data/opa/examples/violations</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span></code></pre></div><blockquote><p>Since the <code>data</code> document includes both base and virtual documents,
it is possible to query for both at the same time. The easiest way
to illustrate this is to query for <em>all</em> of <code>data</code> at once. Note,
OPA does NOT allow base and virtual documents to overlap. For
example, if you try to load a rule that defines a virtual document
at path a/b/c (which is already defined by a base document), OPA
will return an error. Similarly, if you try to load a base document
into a path that is already defined by a virtual document, OPA will
also return an error.</p></blockquote><h3 id=the-input-document>The <code>input</code> Document</h3><p>In some cases, policies require input values. In addition to the built-in
<code>data</code> document, OPA also has a built-in <code>input</code> document. When you query
OPA, you can set the value of the <code>input</code> document.</p><p>Example <code>input</code> document:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;GET&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;/servers/s2&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;alice&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The <code>input</code> document can be referenced just like the <code>data</code> document.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># Let &#39;bob&#39; perform read-only operations.</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;bob&#34;</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;GET&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># Let &#39;alice&#39; perform any operation.</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;alice&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><h2 id=putting-it-all-together>Putting It All Together</h2><p>Let’s take a look at some documents representing the state of a hypothetical service and a policy module that uses this data. The following documents describe a set of servers, the protocols they use, the ports they open, and the networks those ports are connected to.</p><p>Example <code>data</code> document:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;ssh&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p2&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;db&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;mysql&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s3&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;memcache&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;http&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s4&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;http&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p2&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;networks&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;n1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;public&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;n2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;public&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;n3&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;public&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>true</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>],</span>
  <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;networks&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;n1&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;p2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;networks&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;n3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;p3&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;networks&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;n2&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>When the data is published, we can use OPA’s API to inspect base documents like servers:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>https://example.com/v1/data/servers</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span></code></pre></div><p>The response is an object that contains the array of servers:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;result&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s1&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;ssh&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p2&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s2&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;db&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;mysql&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s3&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cache&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;memcache&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;http&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p3&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s4&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;http&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p2&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Now let’s write a policy that enumerates servers that are connected to public networks and that are using HTTP. These servers are violating a business rule that states that all public servers must use HTTPS.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># This policy module belongs to the opa.examples package.</span>
<span style=color:#000>package</span> <span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span>

<span style=color:#8f5902;font-style:italic># Refer to data.servers as `servers`.</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span>
<span style=color:#8f5902;font-style:italic># Refer to the data.networks as `networks`.</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>networks</span>
<span style=color:#8f5902;font-style:italic># Refer to the data.ports as `ports`.</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ports</span>

<span style=color:#8f5902;font-style:italic># A server exists in the violations set if...</span>
<span style=color:#000>violations</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic># ...the server exists</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#8f5902;font-style:italic># ...and any of the server’s protocols is HTTP</span>
    <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protocols</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;http&#34;</span>
    <span style=color:#8f5902;font-style:italic># ...and the server is public.</span>
    <span style=color:#000>public_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># A server exists in the public_servers set if...</span>
<span style=color:#000>public_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic># ...the server exists</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#8f5902;font-style:italic># ...and the server is connected to a port</span>
    <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ports</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>ports</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>id</span>
    <span style=color:#8f5902;font-style:italic># ...and the port is connected to a network</span>
    <span style=color:#000>ports</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>networks</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>networks</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>id</span>
    <span style=color:#8f5902;font-style:italic># ...and the network is public.</span>
    <span style=color:#000>networks</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>public</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>true</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Note that:</p><ul><li>Rules consist of assertions about data stored in OPA. In this case, the assertions test for equality with, and membership of, values in the servers, networks, and ports documents.</li><li>Expressions can reference elements in a collection using the <code>[_]</code> and <code>[&lt;variable&gt;]</code> syntax. OPA knows to evaluate such queries by iterating over each element in the corresponding collection.</li><li>Assertions about elements in a collection are <code>true</code> if any of the elements match the expression, and are only <code>false</code> when none of the elements match. For example, <code>ports[i].networks[_] == networks[j].id</code> will be <code>true</code> whenever any element in <code>ports[i].networks</code> matches the id of any element in <code>networks</code>.</li><li>Expressions can reference nested documents. For example, <code>ports[i].networks[_]</code> refers to each network ID listed in each port document.</li><li>Expressions can reference virtual documents. For example, <code>public_servers[server] == true</code> matches only if <code>server</code> is in the list produced by the <code>public_servers</code> rule.</li></ul><p>After publishing this policy module, the <code>data</code> document will include
additional documents corresponding to the module’s package declaration
(opa.examples) and the virtual documents its rules generate.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>https://example.com/v1/data</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span> <span style=color:#0000cf;font-weight:700>200</span> <span style=color:#c00;font-weight:700>OK</span>
<span style=color:#000>Content-Type</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>application/json</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;result&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>],</span>
    <span style=color:#204a87;font-weight:700>&#34;networks&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>],</span>
    <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#a40000>...</span><span style=color:#000;font-weight:700>],</span>
    <span style=color:#204a87;font-weight:700>&#34;opa&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;examples&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>&#34;violations&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
          <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s4&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
              <span style=color:#4e9a06>&#34;http&#34;</span>
            <span style=color:#000;font-weight:700>],</span>
            <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
              <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#4e9a06>&#34;p2&#34;</span>
            <span style=color:#000;font-weight:700>]</span>
          <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>],</span>
        <span style=color:#204a87;font-weight:700>&#34;public_servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
          <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s1&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
              <span style=color:#4e9a06>&#34;https&#34;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#4e9a06>&#34;ssh&#34;</span>
            <span style=color:#000;font-weight:700>],</span>
            <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
              <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#4e9a06>&#34;p2&#34;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#4e9a06>&#34;p3&#34;</span>
            <span style=color:#000;font-weight:700>]</span>
          <span style=color:#000;font-weight:700>},</span>
          <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s4&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
              <span style=color:#4e9a06>&#34;http&#34;</span>
            <span style=color:#000;font-weight:700>],</span>
            <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
              <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
              <span style=color:#4e9a06>&#34;p2&#34;</span>
            <span style=color:#000;font-weight:700>]</span>
          <span style=color:#000;font-weight:700>}</span>
        <span style=color:#000;font-weight:700>]</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>In this case, we are only interested in the set of servers that violate the
policy. We can use OPA&rsquo;s API to query for just those servers.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>https://example.com/v1/data/opa/examples/violations</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span></code></pre></div><p>&hellip;the response is the subset of the servers base document that use HTTP and are connected to a public network:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span> <span style=color:#0000cf;font-weight:700>200</span> <span style=color:#c00;font-weight:700>OK</span>
<span style=color:#000>Content-Type</span><span style=color:#ce5c00;font-weight:700>:</span> <span style=color:#000>application/json</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
  <span style=color:#204a87;font-weight:700>&#34;result&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;s4&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>,</span>
      <span style=color:#204a87;font-weight:700>&#34;protocols&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;http&#34;</span>
      <span style=color:#000;font-weight:700>],</span>
      <span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
        <span style=color:#4e9a06>&#34;p1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;p2&#34;</span>
      <span style=color:#000;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div></div></section></div></article></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js></script><script src=/js/app.145c7a3bc61d0b561cc282851776ffdcd33e6b35aebca1b05449aa9195eaf751.js integrity="sha256-FFx6O8YdC1YcwoKFF3b/3NM&#43;azWuvKGwVEmqkZXq91E="></script></body></html>