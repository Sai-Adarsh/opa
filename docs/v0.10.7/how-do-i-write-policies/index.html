<!doctype html><html lang=en><head><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-84550302-1','auto');ga('send','pageview');</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=description content="Policy-based control for cloud native environments"><meta property=og:title content="How Do I Write Policies?"><meta property=og:type content=documentation><meta property=og:url content=https://openpolicyagent.org/docs/v0.10.7/how-do-i-write-policies/><meta property=og:locale content=en_US><meta property=og:site_name content="Open Policy Agent"><meta property=og:description content="Policy-based control for cloud native environments"><meta name=og:type content=article><meta name=og:image content=https://openpolicyagent.org/img/logos/opa-horizontal-color.png><meta name=og:image:alt content="Open Policy Agent project logo"><meta name=og:image:type content=image/png><meta name=twitter:card content=summary><meta name=twitter:site content=@OpenPolicyAgent><meta name=twitter:creator content=@OpenPolicyAgent><link rel=canonical content=https://openpolicyagent.org/docs/v0.10.7/how-do-i-write-policies/><link rel="shortcut icon" href=/favicon.png type=image/x-icon><meta name=generator content="Hugo 0.53"><title>Open Policy Agent | How Do I Write Policies?</title><link rel=stylesheet href=/css/style.6bbca25e01250b8412df90aabdfbddb4f7b3b892dd593d933cd29794b98a3373.css integrity="sha256-a7yiXgElC4QS35CqvfvdtPezuJLdWT2TPNKXlLmKM3M="></head><body><div class=dashboard><div class="dashboard-panel left has-background-white-bis is-hidden-mobile"><div class="dashboard-panel-header has-text-centered"><div class=dashboard-panel-header-logo><a href=https://openpolicyagent.org><img src=/img/logos/opa-stacked-color.png></a></div><div class="dropdown is-left"><div class=dropdown-trigger><span class="button is-primary"><span><strong>v0.10.7</strong>
<span class="tag latest-tag is-success is-small has-text-weight-bold">latest</span></span></span></div></div></div><div class="dashboard-panel-content is-scrollable"><div class=docs-nav><span class=docs-nav-title>Documentation</span>
<a class=docs-nav-item href=/docs/v0.10.7/>Introduction</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class="docs-nav-item is-active" href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#what-is-rego>What is Rego?</a></li><li><a href=#why-use-rego>Why use Rego?</a></li><li><a href=#the-basics>The Basics</a></li><li><a href=#scalar-values>Scalar Values</a></li><li><a href=#strings>Strings</a></li><li><a href=#composite-values>Composite Values</a><ul><li><a href=#sets>Sets</a></li></ul></li><li><a href=#variables>Variables</a></li><li><a href=#references>References</a><ul><li><a href=#variable-keys>Variable Keys</a></li><li><a href=#composite-keys>Composite Keys</a></li><li><a href=#multiple-expressions>Multiple Expressions</a></li><li><a href=#self-joins>Self-Joins</a></li></ul></li><li><a href=#comprehensions>Comprehensions</a><ul><li><a href=#array-comprehensions>Array Comprehensions</a></li><li><a href=#object-comprehensions>Object Comprehensions</a></li><li><a href=#set-comprehensions>Set Comprehensions</a></li></ul></li><li><a href=#rules>Rules</a><ul><li><a href=#generating-sets>Generating Sets</a></li><li><a href=#generating-objects>Generating Objects</a></li><li><a href=#incremental-definitions>Incremental Definitions</a></li><li><a href=#complete-definitions>Complete Definitions</a></li><li><a href=#functions>Functions</a></li></ul></li><li><a href=#negation>Negation</a></li><li><a href=#modules>Modules</a><ul><li><a href=#comments>Comments</a></li><li><a href=#packages>Packages</a></li><li><a href=#imports>Imports</a></li></ul></li><li><a href=#with-keyword>With Keyword</a></li><li><a href=#default-keyword>Default Keyword</a></li><li><a href=#else-keyword>Else Keyword</a></li><li><a href=#operators>Operators</a><ul><li><a href=#equality-assignment-comparison-and-unification>Equality: Assignment, Comparison, and Unification</a><ul><li><a href=#assignment>Assignment <code>:=</code></a></li><li><a href=#comparison>Comparison <code>==</code></a></li><li><a href=#unification>Unification <code>=</code></a></li><li><a href=#best-practices-for-equality>Best Practices for Equality</a></li></ul></li><li><a href=#comparison-operators>Comparison Operators</a></li></ul></li><li><a href=#built-in-functions>Built-in Functions</a></li><li><a href=#example-data>Example Data</a></li></ul></li></ul></nav></div><a class=docs-nav-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=docs-nav-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=docs-nav-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=docs-nav-item href=/docs/v0.10.7/status/>Status</a>
<a class=docs-nav-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=docs-nav-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=docs-nav-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=docs-nav-item href=/docs/v0.10.7/security/>Security</a>
<a class=docs-nav-item href=/docs/v0.10.7/plugins/>Plugins</a>
<a class=docs-nav-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=docs-nav-item href=/docs/v0.10.7/faq/>FAQ</a>
<a class=docs-nav-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><hr class=docs-nav-hr><span class=docs-nav-title>Tutorials</span>
<a class=docs-nav-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=docs-nav-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=docs-nav-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=docs-nav-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><hr class=docs-nav-hr><span class=docs-nav-title>Guides</span>
<a class=docs-nav-item href=/docs/v0.10.7/guides-identity/>Identity and User Attributes</a>
<a class=docs-nav-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Kubernetes Admission Control</a></div></div></div><div class="dashboard-main is-scrollable"><nav class="navbar is-primary"><div class="navbar-brand is-hidden-tablet"><a class=navbar-item href=https://openpolicyagent.org><img src=/img/logos/opa-icon-white.png></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=mobile-menu><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div class="navbar-menu is-hidden-tablet" id=mobile-menu><div class=navbar-start><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Documentation</span>
<a class=navbar-item href=/docs/v0.10.7/>Introduction</a>
<a class=navbar-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=navbar-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=navbar-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=navbar-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=navbar-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=navbar-item href=/docs/v0.10.7/status/>Status</a>
<a class=navbar-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=navbar-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=navbar-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=navbar-item href=/docs/v0.10.7/security/>Security</a>
<a class=navbar-item href=/docs/v0.10.7/plugins/>Plugins (Experimental)</a>
<a class=navbar-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=navbar-item href=/docs/v0.10.7/faq/>Frequently Asked Questions</a>
<a class=navbar-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Tutorials</span>
<a class=navbar-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=navbar-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=navbar-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=navbar-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Guides</span>
<a class=navbar-item href=/docs/v0.10.7/guides-identity/>Guides: Identity and User Attributes</a>
<a class=navbar-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Guides: Kubernetes Admission Control</a></div><div class=navbar-end><div class=navbar-item><div class=buttons><a class="button is-primary" href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class="button is-primary" href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class="button is-primary" href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class="button is-primary" href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></div></div><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class=navbar-item href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class=navbar-item href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class=navbar-item href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></nav><article class=article><div class=container><section class=hero><div class=hero-body><p class="title is-size-1 is-size-2-mobile">How Do I Write Policies?</p></div></section><section class=section><div class=content><p>OPA is purpose built for reasoning about information represented in structured
documents. The data that your service and its users publish can be inspected and
transformed using OPA’s native query language Rego.</p><h2 id=what-is-rego>What is Rego?</h2><p>Rego was inspired by <a href=https://en.wikipedia.org/wiki/Datalog>Datalog</a>, which is
a well understood, decades old query language. Rego extends Datalog to support
structured document models such as JSON.</p><p>Rego queries are assertions on data stored in OPA. These queries can be used to
define policies that enumerate instances of data that violate the expected state
of the system.</p><h2 id=why-use-rego>Why use Rego?</h2><p>Use Rego for defining policy that is easy to read and write.</p><p>Rego focuses on providing powerful support for referencing nested documents and
ensuring that queries are correct and unambiguous.</p><p>Rego is declarative so policy authors can focus on what queries should return
rather than how queries should be executed. These queries are simpler and more
concise than the equivalent in an imperative language.</p><p>Like other applications which support declarative query languages, OPA is able
to optimize queries to improve performance.</p><h2 id=the-basics>The Basics</h2><p>This section introduces the main aspects of Rego.</p><p>The simplest rule is a single expression and is defined in terms of a <a href=#scalar-values>Scalar Value</a>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>pi</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14159</span></code></pre></div><p>Rules define the content of documents. We can query for the content of the <code>pi</code> document generated by the rule above:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pi</span>
<span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14159</span></code></pre></div><p>Rules can also be defined in terms of <a href=#composite-values>Composite Values</a>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>rect</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;width&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;height&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rect</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;height&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;width&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>You can compare two scalar or composite values, and when you do so you are checking if the two values are the same JSON value.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>rect</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;height&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;width&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>You can define a new concept using a rule. For example, <code>v</code> below is true if the equality expression is true.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>v</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;world&#34;</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>If we evaluate <code>v</code> on its own, the REPL prints <code>undefined</code> because the body
of the rule never evaluates to <code>true</code>. As a result, the document generated by
the rule is not defined.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>v</span>
<span style=color:#000>undefined</span></code></pre></div><p>Expressions that refer to undefined values are also undefined.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>v</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>true</span>
<span style=color:#000>undefined</span></code></pre></div><p>We can define rules in terms of <a href=#variables>Variables</a> as well:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>t</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>41</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>The formal syntax uses the semicolon character <code>;</code> to separate expressions. Rule
bodies can separate expressions with newlines and omit the semicolon:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>t2</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>41</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>When evaluating rule bodies, OPA searches for variable bindings that make all of
the expressions true. There may be multiple sets of bindings that make the rule
body true. The rule body can be understood intuitively as:</p><pre><code>expression-1 AND expression-2 AND ... AND expression-N
</code></pre><p>The rule itself can be understood intuitively as:</p><pre><code>rule-name IS value IF body
</code></pre><p>If the <strong>value</strong> is omitted, it defaults to <strong>true</strong>.</p><p>When we query for the contents of <code>t</code> we see the obvious result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>The order of expressions in a rule does not affect the document’s content.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>s</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span>
    <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>41</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The query result is the same:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>There&rsquo;s one exception: if you use assignment <code>:=</code> the compiler will check
that the variable you are assigning has not already been used.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>s</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>41</span>
    <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span>

<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Rego <a href=#references>References</a> help you refer to nested documents. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>sites</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;prod&#34;</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;smoke1&#34;</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>}</span><span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#000>r</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;prod&#34;</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>The rule <code>r</code> above asserts that there exists (at least) one document within <code>sites</code> where the <code>name</code> attribute equals <code>&quot;prod&quot;</code>.</p><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>r</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>We can generalize the example above with a rule that defines a set document instead of a boolean document:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>The value of <code>q</code> is a set of names</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span>
<span style=color:#ce5c00;font-weight:700>[</span>
  <span style=color:#4e9a06>&#34;prod&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;smoke&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;dev&#34;</span>
<span style=color:#ce5c00;font-weight:700>]</span></code></pre></div><p>We can re-write the rule <code>r</code> from above to make use of <code>q</code>. We will call the new rule <code>p</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#204a87>p</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;prod&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result will be the same:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87>p</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>Rules which have arguments can be queried with input values:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;smoke2&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>undefined</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>If you made it this far, congratulations!</p><p>This section introduced the main aspects of Rego. The rest of this document
walks through each part of the language in more detail.</p><p>For a concise reference, see the <a href=../language-reference>Language
Reference</a> document.</p><h2 id=scalar-values>Scalar Values</h2><p>Scalar values are the simplest type of term in Rego. Scalar values can be <a href=#strings>Strings</a>, numbers, booleans, or null.</p><p>Documents can be defined solely in terms of scalar values. This is useful for defining constants that are referenced in multiple places. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>greeting</span>   <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Hello&#34;</span>
<span style=color:#000>max_height</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span>
<span style=color:#000>pi</span>         <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14159</span>
<span style=color:#000>allowed</span>    <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span>
<span style=color:#000>location</span>   <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>null</span></code></pre></div><p>These documents can be queried like any other:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>greeting</span>
<span style=color:#4e9a06>&#34;Hello&#34;</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>max_height</span>
<span style=color:#0000cf;font-weight:700>42</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>pi</span>
<span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14159</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allowed</span>
<span style=color:#204a87;font-weight:700>true</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>location</span>
<span style=color:#000>null</span></code></pre></div><h2 id=strings>Strings</h2><p>Rego supports two different types of syntax for declaring strings. The first is likely to be the most familiar: characters surrounded by double quotes.
In such strings, certain characters must be escaped to appear in the string, such as double quotes themselves, backslashes, etc. See the <a href=../language-reference>Language
Reference</a> for a formal definition.</p><p>The other type of string declaration is a raw string declaration. These are made of characters surrounded by backticks (<code>`</code>), with the exception
that raw strings may not contain backticks themselves. Raw strings are what they sound like: escape sequences are not interpreted, but instead taken
as the literal text inside the backticks. For example, the raw string <code>`hello\there`</code> will be the text &ldquo;hello\there&rdquo;, not &ldquo;hello&rdquo; and &ldquo;here&rdquo;
separated by a tab. Raw strings are particularly useful when constructing regular expressions for matching, as it eliminates the need to double
escape special characters.</p><p>A simple example is a regex to match a valid Rego variable. With a regular string, the regex is <code>&quot;[a-zA-Z_]\\w*&quot;</code>, but with raw strings, it becomes <code>`[a-zA-Z_]\w*`</code>.</p><h2 id=composite-values>Composite Values</h2><p>Composite values define collections. In simple cases, composite values can be treated as constants like <a href=#scalar-values>Scalar Values</a>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>cube</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;width&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;height&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;depth&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>cube</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>width</span>
<span style=color:#0000cf;font-weight:700>3</span></code></pre></div><p>Composite values can also be defined in terms of <a href=#variables>Variables</a> or <a href=#references>References</a>. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>a</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>b</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>c</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>null</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>d</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;x&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>b</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>+----+-------+------+---------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>A</span>  <span style=color:#ce5c00;font-weight:700>|</span>   <span style=color:#000>B</span>   <span style=color:#ce5c00;font-weight:700>|</span>  <span style=color:#000>C</span>   <span style=color:#ce5c00;font-weight:700>|</span>             <span style=color:#000>D</span>             <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+----+-------+------+---------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>42</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#204a87;font-weight:700>false</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>null</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;x&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>null</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+----+-------+------+---------------------------+</span></code></pre></div><p>By defining composite values in terms of variables and references, rules can define abstractions over raw data and other rules.</p><h3 id=sets>Sets</h3><p>In addition to arrays and objects, Rego supports set values. Sets are unordered
collections of unique values. Just like other composite values, sets can be
defined in terms of scalars, variables, references, and other composite values.
For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#000>cube</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>width</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cube</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>height</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cube</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>depth</span><span style=color:#000;font-weight:700>};</span> <span style=color:#000>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>n</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>+---+---------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|</span>    <span style=color:#000>s</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+---------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+---------+</span></code></pre></div><blockquote><p>Set documents are collections of values without keys. OPA represents set
documents as arrays when serializing to JSON or other formats that do not
support a set data type. The important distinction between sets and arrays or
objects is that sets are unkeyed while arrays and objects are keyed, i.e., you
cannot refer to the index of an element within a set.</p></blockquote><p>When comparing sets, the order of elements does not matter:</p><pre><code>&gt; {1,2,3} == {3,1,2}
true
</code></pre><p>Because sets are unordered, variables inside sets must be unified with a ground
value outside of the set. If the variable is not unified with a ground value
outside the set, OPA will complain:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>error</span> <span style=color:#4e9a06>occurred</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>rego_unsafe_var_error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>var</span> <span style=color:#000>x</span> <span style=color:#000>is</span> <span style=color:#000>unsafe</span></code></pre></div><p>Because sets share curly-brace syntax with objects, and an empty object is
defined with <code>{}</code>, an empty set has to be constructed with a different syntax:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>set</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>n</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>+---+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+</span></code></pre></div><h2 id=variables>Variables</h2><p>Variables are another kind of term in Rego. They appear in both the head and body of rules.</p><p>Variables appearing in the head of a rule can be thought of as input and output of the rule. Unlike many programming languages, where a variable is either an input or an output, in Rego a variable is simultaneously an input and an output. If a query supplies a value for a variable, that variable is an input, and if the query does not supply a value for a variable, that variable is an output.</p><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>sites</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;prod&#34;</span><span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;smoke1&#34;</span><span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>In this case, we evaluate <code>q</code> with a variable <code>x</code> (which is not bound to a value). As as result, the query returns all of the values for <code>x</code> and all of the values for <code>q[x]</code>, which are always the same because <code>q</code> is a set.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+----------+----------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>    <span style=color:#000>x</span>     <span style=color:#ce5c00;font-weight:700>|</span>   <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+----------+----------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;prod&#34;</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;prod&#34;</span>   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;smoke1&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;smoke1&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;dev&#34;</span>    <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;dev&#34;</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+----------+----------+</span></code></pre></div><p>On the other hand, if we evaluate <code>q</code> with an input value for <code>name</code> we can determine whether <code>name</code> exists in the document defined by <code>q</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;smoke2&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>undefined</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>q</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>Variables appearing in the head of a rule must also appear in a non-negated equality expression within the same rule. This property ensures that if the rule is evaluated and all of the expressions evaluate to true for some set of variable bindings, the variable in the head of the rule will be defined.</p><h2 id=references>References</h2><p>References are used to access nested documents.</p><p>The examples in this section use the data defined in the <a href=#example-data>Examples</a> section.</p><p>The simplest reference contains no variables. For example, the following reference returns the hostname of the second server in the first site document from our example data:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hostname</span>
<span style=color:#4e9a06>&#34;helium&#34;</span></code></pre></div><p>References are typically written using the “dot-access” style. The canonical form does away with <code>.</code> and closely resembles dictionary lookup in a language such as Python:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#4e9a06>&#34;servers&#34;</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#4e9a06>&#34;helium&#34;</span></code></pre></div><p>Both forms are valid, however, the dot-access style is typically more readable. Note that there are four cases where brackets must be used:</p><ol><li>String keys containing characters other than <code>[a-z]</code>, <code>[A-Z]</code>, <code>[0-9]</code>, or <code>_</code> (underscore).</li><li>Non-string keys such as numbers, booleans, and null.</li><li>Variable keys which are described later.</li><li>Composite keys which are described later.</li></ol><p>References are always prefixed with a variable that identifies the root
document. In the example above this is <code>p</code>. The root document may be:</p><ul><li>a local variable inside a rule.</li><li>a rule inside the same package.</li><li>a document stored in OPA.</li><li>a documented temporarily provided to OPA as part of a transaction.</li></ul><h3 id=variable-keys>Variable Keys</h3><p>References can include variables as keys. References written this way are used to select a value from every element in a collection.</p><p>The following reference will select the hostnames of all the servers in our
example data:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hostname</span>
<span style=color:#ce5c00;font-weight:700>+---+---+------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>j</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hostname</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+---+------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;hydrogen&#34;</span>                   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;helium&#34;</span>                     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;lithium&#34;</span>                    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;beryllium&#34;</span>                  <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;boron&#34;</span>                      <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;carbon&#34;</span>                     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;nitrogen&#34;</span>                   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;oxygen&#34;</span>                     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+---+------------------------------+</span></code></pre></div><p>Conceptually, this is the same as the following imperative (Python) code:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#204a87;font-weight:700>def</span> <span style=color:#000>hostnames</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sites</span><span style=color:#000;font-weight:700>):</span>
    <span style=color:#000>result</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span>
    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>site</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>sites</span><span style=color:#000;font-weight:700>:</span>
        <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>server</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>site</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span><span style=color:#000;font-weight:700>:</span>
            <span style=color:#000>result</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hostname</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>result</span></code></pre></div><p>In the reference above, we effectively used variables named <code>i</code> and <code>j</code> to iterate the collections. If the variables are unused outside the reference, we prefer to replace them with an underscore (<code>_</code>) character. The reference above can be rewritten as:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hostname</span>
<span style=color:#ce5c00;font-weight:700>+------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hostname</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;hydrogen&#34;</span>                   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;helium&#34;</span>                     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;lithium&#34;</span>                    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;beryllium&#34;</span>                  <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;boron&#34;</span>                      <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;carbon&#34;</span>                     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;nitrogen&#34;</span>                   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;oxygen&#34;</span>                     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+------------------------------+</span></code></pre></div><p>The underscore is special because it cannot be referred to by other parts of the rule, e.g., the other side of the expression, another expression, etc. The underscore can be thought of as a special iterator. Each time an underscore is specified, a new iterator is instantiated.</p><blockquote><p>Under the hood, OPA translates the <code>_</code> character to a unique variable name that does not conflict with variables and rules that are in scope.</p></blockquote><h3 id=composite-keys>Composite Keys</h3><p>References can include <a href=#composite-values>Composite Values</a> as keys if the key is being used to refer into a set. Composite keys may not be used in refs
for base data documents, they are only valid for references into virtual documents.</p><p>This is useful for checking for the presence of composite values within a set, or extracting all values within a set matching some pattern.
For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>6</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>[[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>]]</span>
<span style=color:#ce5c00;font-weight:700>[</span>
  <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#0000cf;font-weight:700>2</span>
<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>[[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]]</span>
<span style=color:#ce5c00;font-weight:700>+---+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---+</span></code></pre></div><h3 id=multiple-expressions>Multiple Expressions</h3><p>Rules are often written in terms of multiple expressions that contain references to documents. In the following example, the rule defines a set of arrays where each array contains an application name and a hostname of a server where the application is deployed.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>apps_and_hostnames</span><span style=color:#ce5c00;font-weight:700>[[</span><span style=color:#204a87>name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>]]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>server</span>
    <span style=color:#000>hostname</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hostname</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>apps_and_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+----------------------+-----------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>          <span style=color:#000>x</span>           <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>apps_and_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+----------------------+-----------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;hydrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;hydrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;helium&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>     <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;helium&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;beryllium&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;beryllium&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;boron&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;boron&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>       <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;nitrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;nitrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;mysql&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;lithium&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;mysql&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;lithium&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;mysql&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;carbon&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;mysql&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;carbon&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;mongodb&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;oxygen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;mongodb&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;oxygen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>  <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+----------------------+-----------------------+</span></code></pre></div><p>Don’t worry about understanding everything in this example right now. There are just two important points:</p><ol><li>Several variables appear more than once in the body. When a variable is used in multiple locations, OPA will only produce documents for the rule with the variable bound to the same value in all expressions.</li><li>The rule is joining the <code>apps</code> and <code>sites</code> documents implicitly. In Rego (and other languages based on Datalog), joins are implicit.</li></ol><h3 id=self-joins>Self-Joins</h3><p>Using a different key on the same array or object provides the equivalent of self-join in SQL. For example, the following rule defines a document containing apps deployed on the same site as <code>&quot;mysql&quot;</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>same_site</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;mysql&#34;</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>server</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span>
    <span style=color:#000>other_server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>j</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span>
    <span style=color:#000>server</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>other_server</span>
    <span style=color:#000>other_server</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>same_site</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-------+--------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>   <span style=color:#000>x</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>same_site</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-------+--------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>        <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>        <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>        <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>        <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-------+--------------+</span></code></pre></div><h2 id=comprehensions>Comprehensions</h2><p>Comprehensions provide a concise way of building <a href=#composite-values>Composite Values</a> from sub-queries.</p><p>Like <a href=#rules>Rules</a>, comprehensions consist of a head and a body. The body of a comprehension can be understood in exactly the same way as the body of a rule, that is, one or more expressions that must all be true in order for the overall body to be true. When the body evaluates to true, the head of the comprehension is evaluated to produce an element in the result.</p><p>The body of a comprehension is able to refer to variables defined in the outer body. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>region</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;west&#34;</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>names</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>region</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-----------------+--------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>      <span style=color:#000>names</span>      <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------------+--------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;smoke&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;west&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------------+--------+</span></code></pre></div><p>In the above query, the second expression contains an <a href=#array-comprehensions>Array Comprehension</a> that refers to the <code>region</code> variable. The region variable will be bound in the outer body.</p><blockquote><p>When a comprehension refers to a variable in an outer body, OPA will reorder expressions in the outer body so that variables referred to in the comprehension are bound by the time the comprehension is evaluated.</p></blockquote><p>Comprehensions are similar to the same constructs found in other languages like Python. For example, we could write the above comprehension in Python as follows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># Python equivalent of Rego comprehension shown above.</span>
<span style=color:#000>names</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>site</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>site</span> <span style=color:#204a87;font-weight:700>in</span> <span style=color:#000>sites</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>site</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;west&#34;</span><span style=color:#ce5c00;font-weight:700>]</span></code></pre></div><p>Comprehensions are often used to group elements by some key. A common use case for comprehensions is to assist in computing aggregate values (e.g., the number of containers running on a host).</p><h3 id=array-comprehensions>Array Comprehensions</h3><p>Array Comprehensions build array values out of sub-queries. Array Comprehensions have the form:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>term</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>]</span></code></pre></div><p>For example, the following rule defines an object where the keys are application names and the values are hostnames of servers where the application is deployed. The hostnames of servers are represented as an array.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app_name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hostnames</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>app</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>app_name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span>
    <span style=color:#000>hostnames</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>hostname</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
                            <span style=color:#000>s</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
                            <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>name</span>
                            <span style=color:#000>hostname</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>    <span style=color:#000>app</span>    <span style=color:#ce5c00;font-weight:700>|</span>                <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>     <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;hydrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;helium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;beryllium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;boron&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;nitrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mysql&#34;</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;lithium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;carbon&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mongodb&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;oxygen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                           <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span></code></pre></div><h3 id=object-comprehensions>Object Comprehensions</h3><p>Object Comprehensions build object values out of sub-queries. Object Comprehensions have the form:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>term</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>We can use Object Comprehensions to write the rule from above as a comprehension instead:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>app_to_hostnames</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>hostnames</span> <span style=color:#ce5c00;font-weight:700>|</span>
    <span style=color:#000>app</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>hostnames</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>hostname</span> <span style=color:#ce5c00;font-weight:700>|</span>
                    <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
                    <span style=color:#000>s</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
                    <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>name</span>
                    <span style=color:#000>hostname</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result is the same:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>    <span style=color:#000>app</span>    <span style=color:#ce5c00;font-weight:700>|</span>                <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>     <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;hydrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;helium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;beryllium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;boron&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;nitrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mysql&#34;</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;lithium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;carbon&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mongodb&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;oxygen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                           <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span></code></pre></div><p>Object comprehensions are not allowed to have conflicting entries, similar to rules:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>z</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>z</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>}</span>
<span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>eval_conflict_error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>object</span> <span style=color:#000>keys</span> <span style=color:#000>must</span> <span style=color:#000>be</span> <span style=color:#000>unique</span></code></pre></div><h3 id=set-comprehensions>Set Comprehensions</h3><p>Set Comprehensions build set values out of sub-queries. Set Comprehensions have the form:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>term</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>body</span><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>For example, to construct a set from an array:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>a</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>a</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>b</span>
<span style=color:#ce5c00;font-weight:700>[</span>
  <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#0000cf;font-weight:700>5</span>
<span style=color:#ce5c00;font-weight:700>]</span></code></pre></div><h2 id=rules>Rules</h2><p>Rules define the content of <a href=../how-does-opa-work#rules-and-virtual-documents>Virtual Documents</a> in
OPA. When OPA evaluates a rule, we say OPA <em>generates</em> the content of the
document that is defined by the rule.</p><p>The sample code in this section make use of the data defined in <a href=#example-data>Examples</a>.</p><h3 id=generating-sets>Generating Sets</h3><p>The following rule defines a set containing the hostnames of all servers:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>hostname</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>When we query for the content of <code>hostnames</code> we see the same data as we would if we queried using the <code>sites[_].servers[_].hostname</code> reference directly:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-------------+-----------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>    <span style=color:#204a87>name</span>     <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-------------+-----------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;hydrogen&#34;</span>  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;hydrogen&#34;</span>      <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;helium&#34;</span>    <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;helium&#34;</span>        <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;lithium&#34;</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;lithium&#34;</span>       <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;beryllium&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;beryllium&#34;</span>     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;boron&#34;</span>     <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;boron&#34;</span>         <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;carbon&#34;</span>    <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;carbon&#34;</span>        <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;nitrogen&#34;</span>  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;nitrogen&#34;</span>      <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;oxygen&#34;</span>    <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;oxygen&#34;</span>        <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-------------+-----------------+</span></code></pre></div><p>This example introduces a few important aspects of Rego.</p><p>First, the rule defines a set document where the contents are defined by the variable <code>name</code>. We know this rule defines a set document because the head only includes a key. All rules have the following form (where key, value, and body are all optional):</p><pre><code>&lt;name&gt; &lt;key&gt;? &lt;value&gt;? &lt;body&gt;?
</code></pre><p>For a more formal definition of the rule syntax, see the <a href=../language-reference#grammar>Language Reference</a> document.</p><p>Second, the <code>sites[_].servers[_].hostname</code> fragment selects the <code>hostname</code> attribute from all of the objects in the <code>servers</code> collection. From reading the fragment in isolation we cannot tell whether the fragment refers to arrays or objects. We only know that it refers to a collections of values.</p><p>Third, the <code>name := sites[_].servers[_].hostname</code> expression binds the value of the <code>hostname</code> attribute to the variable <code>name</code>, which is also declared in the head of the rule.</p><h3 id=generating-objects>Generating Objects</h3><p>Rules that define objects are very similar to rules that define sets.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>apps_by_hostname</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>hostname</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hostname</span>
    <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span>
    <span style=color:#000>app</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The rule above defines an object that maps hostnames to app names. The main difference between this rule and one which defines a set is the rule head: in addition to declaring a key, the rule head also declares a value for the document.</p><p>The result:</p><pre><code>&gt; apps_by_hostname[&quot;helium&quot;]
&quot;web&quot;
</code></pre><h3 id=incremental-definitions>Incremental Definitions</h3><p>A rule may be defined multiple times with the same name. When a rule is defined
this way, we refer to the rule definition as <em>incremental</em> because each
definition is additive. The document produced by incrementally defined rules is
the union of the documents produced by each individual rule.</p><p>For example, we can write a rule that abstracts over our <code>servers</code> and
<code>containers</code> data as <code>instances</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>instances</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>instance</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hostname</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>instances</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>container</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>containers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>instance</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ipaddress</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>If the head of the rule is same, we can chain multiple rule bodies together to
obtain the same result. We don&rsquo;t recommend using this form anymore.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>instances</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>instance</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>instance</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hostname</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>container</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>containers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>instance</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>ipaddress</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>container</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>An incrementally defined rule can be intuitively understood as <code>&lt;rule-1&gt; OR &lt;rule-2&gt; OR ... OR &lt;rule-N&gt;</code>.</p><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>instances</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-----------------------------------------------+-----------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>                       <span style=color:#000>x</span>                       <span style=color:#ce5c00;font-weight:700>|</span>                 <span style=color:#000>instances</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span>                  <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------------------------------------------+-----------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;hydrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-0&#34;</span><span style=color:#000;font-weight:700>}</span>         <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;hydrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-0&#34;</span><span style=color:#000;font-weight:700>}</span>         <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;helium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-1&#34;</span><span style=color:#000;font-weight:700>}</span>           <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;helium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-1&#34;</span><span style=color:#000;font-weight:700>}</span>           <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;lithium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;db-0&#34;</span><span style=color:#000;font-weight:700>}</span>           <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;lithium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;db-0&#34;</span><span style=color:#000;font-weight:700>}</span>           <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;beryllium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-1000&#34;</span><span style=color:#000;font-weight:700>}</span>     <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;beryllium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-1000&#34;</span><span style=color:#000;font-weight:700>}</span>     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;boron&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-1001&#34;</span><span style=color:#000;font-weight:700>}</span>         <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;boron&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-1001&#34;</span><span style=color:#000;font-weight:700>}</span>         <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;carbon&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;db-1000&#34;</span><span style=color:#000;font-weight:700>}</span>         <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;carbon&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;db-1000&#34;</span><span style=color:#000;font-weight:700>}</span>         <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;nitrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-dev&#34;</span><span style=color:#000;font-weight:700>}</span>       <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;nitrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;web-dev&#34;</span><span style=color:#000;font-weight:700>}</span>       <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;oxygen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;db-dev&#34;</span><span style=color:#000;font-weight:700>}</span>          <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;oxygen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;db-dev&#34;</span><span style=color:#000;font-weight:700>}</span>          <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;10.0.0.1&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;big_stallman&#34;</span><span style=color:#000;font-weight:700>}</span>  <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;10.0.0.1&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;big_stallman&#34;</span><span style=color:#000;font-weight:700>}</span>  <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;10.0.0.2&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;cranky_euclid&#34;</span><span style=color:#000;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;address&#34;</span><span style=color:#4e9a06>:&#34;10.0.0.2&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#4e9a06>:&#34;cranky_euclid&#34;</span><span style=color:#000;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------------------------------------------+-----------------------------------------------+</span></code></pre></div><h3 id=complete-definitions>Complete Definitions</h3><p>In addition to rules that <em>partially</em> define sets and objects, Rego also
supports so-called <em>complete</em> definitions of any type of document. Rules provide
a complete definition by omitting the key in the head. Complete definitions are
commonly used for constants:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>pi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14159</span></code></pre></div><blockquote><p>Rego allows authors to omit the body of rules. If the body is omitted, it
defaults to true.</p></blockquote><p>Documents produced by rules with complete definitions can only have one value at
a time. If evaluation produces multiple values for the same document, an error
will be returned.</p><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># Define user &#34;bob&#34; for test input.</span>
<span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bob&#34;</span>

<span style=color:#8f5902;font-style:italic># Define two sets of users: power users and restricted users. Accidentally</span>
<span style=color:#8f5902;font-style:italic># include &#34;bob&#34; in both.</span>
<span style=color:#000>power_users</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;alice&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;bob&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;fred&#34;</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#000>restricted_users</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;bob&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;kim&#34;</span><span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># Power users get 32GB memory.</span>
<span style=color:#000>max_memory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>32</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>power_users</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># Restricted users get 4GB memory.</span>
<span style=color:#000>max_memory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>restricted_users</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>Error:</p><pre><code>&gt; max_memory
max_memory: eval_conflict_error: completely defined rules must produce exactly one value
</code></pre><p>OPA returns an error in this case because the rule definitions are in <em>conflict</em>. The value produced by max_memory cannot be 32 and 4 <strong>at the same time</strong>.</p><p>The documents produced by rules with complete definitions may still be undefined:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>unset</span> <span style=color:#000>user</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;johnson&#34;</span>  <span style=color:#8f5902;font-style:italic># user is not in either of the sets defined earlier.</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>max_memory</span>
<span style=color:#000>undefined</span></code></pre></div><p>In some cases, having an undefined result for a document is not desirable. In those cases, policies can use the <a href=#default-keyword>Default Keyword</a> to provide a fallback value.</p><h3 id=functions>Functions</h3><p>Rego supports user-defined functions that can be called with the same semantics as <a href=#built-in-functions>Built-in Functions</a>. They have access to both the <a href=../how-does-opa-work#the-data-document>the data Document</a> and <a href=../how-does-opa-work#the-input-document>the input Document</a>.</p><p>For example, the following function will return the result of trimming the spaces from a string and then splitting it by periods.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>trim_and_split</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span> <span style=color:#000;font-weight:700>{</span>
     <span style=color:#000>t</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>trim</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#000;font-weight:700>)</span>
     <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>split</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>trim_and_split</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;   foo.bar &#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>[</span>
  <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;bar&#34;</span>
<span style=color:#ce5c00;font-weight:700>]</span></code></pre></div><p>Functions may have an arbitrary number of inputs, but exactly one output. Function arguments may be any kind of term. For example, suppose we have the following function:</p><pre><code>foo([x, {&quot;bar&quot;: y}]) = z {
    z := {x: y}
}
</code></pre><p>The following calls would produce the logical mappings given:</p><table><thead><tr><th>Call</th><th><code>x</code></th><th><code>y</code></th></tr></thead><tbody><tr><td><code>z := foo(a)</code></td><td><code>a[0]</code></td><td><code>a[1].bar</code></td></tr><tr><td><code>z := foo([&quot;5&quot;, {&quot;bar&quot;: &quot;hello&quot;}])</code></td><td><code>&quot;5&quot;</code></td><td><code>&quot;hello&quot;</code></td></tr><tr><td><code>z := foo([&quot;5&quot;, {&quot;bar&quot;: [1, 2, 3, [&quot;foo&quot;, &quot;bar&quot;]]}])</code></td><td><code>&quot;5&quot;</code></td><td><code>[1, 2, 3, [&quot;foo&quot;, &quot;bar&quot;]]</code></td></tr></tbody></table><p>If you need multiple outputs, write your functions so that the output is an array, object or set containing your results. If the output term is omitted, it is equivalent to having the output term be the literal <code>true</code>. That is, the function declarations below are equivalent:</p><pre><code>f(x) {
    x == &quot;foo&quot;
}

f(x) = true {
    x == &quot;foo&quot;
}
</code></pre><p>The outputs of user functions have some additional limitations, namely that they must resolve to a single value. If you write a function that has multiple possible bindings for an output variable, you will get a conflict error:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>out</span><span style=color:#000;font-weight:700>):</span> <span style=color:#4e9a06>eval_conflict_error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>functions</span> <span style=color:#000>must</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>produce</span> <span style=color:#000>multiple</span> <span style=color:#000>outputs</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>same</span> <span style=color:#000>inputs</span></code></pre></div><p>It is possible in Rego to define a function more than once, to achieve a conditional selection of which function to execute:</p><p>Functions can be defined incrementally.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>4</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span>
<span style=color:#0000cf;font-weight:700>2</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span>
<span style=color:#0000cf;font-weight:700>8</span></code></pre></div><p>A given function call will execute all functions that match the signature given. If a call matches multiple functions, they must produce the same output, or else a conflict error will occur:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>x</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>4</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span>
<span style=color:#4e9a06>eval_conflict_error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>functions</span> <span style=color:#000>must</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>produce</span> <span style=color:#000>multiple</span> <span style=color:#000>outputs</span> <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>same</span> <span style=color:#000>inputs</span></code></pre></div><p>On the other hand, if a call matches no functions, then the result is undefined.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>4</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span>
<span style=color:#0000cf;font-weight:700>20</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>p</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>y</span>
<span style=color:#000>undefined</span></code></pre></div><h2 id=negation>Negation</h2><p>To generate the content of a <a href=../how-does-opa-work#rules-and-virtual-documents>Virtual Document</a>, OPA attempts to bind variables in the body of the rule such that all expressions in the rule evaluate to True.</p><p>This generates the correct result when the expressions represent assertions about what states should exist in the data stored in OPA. In some cases, you want to express that certain states <em>should not</em> exist in the data stored in OPA. In these cases, negation must be used.</p><p>For safety, a variable appearing in a negated expression must also appear in another non-negated equality expression in the rule.</p><blockquote><p>OPA will reorder expressions to ensure that negated expressions are evaluated after other non-negated expressions with the same variables. OPA will reject rules containing negated expressions that do not meet the safety criteria described above.</p></blockquote><p>The simplest use of negation involves only scalar values or variables and is equivalent to complementing the operator:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>t</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>greeting</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;hello&#34;</span>
    <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>greeting</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;goodbye&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>t</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>Negation is required to check whether some value <em>does not</em> exist in a collection. That is, complementing the operator in an expression such as <code>p[_] == &quot;foo&quot;</code> yields <code>p[_] != &quot;foo&quot;</code>. However, this is not equivalent to <code>not p[&quot;foo&quot;]</code>.</p><p>For example, we can write a rule that defines a document containing names of apps not deployed on the <code>&quot;prod&quot;</code> site:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>prod_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>site</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>site</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;prod&#34;</span>
    <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>site</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>apps_in_prod</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>app</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>prod_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>apps_not_in_prod</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>name</span>
    <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>apps_in_prod</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The result:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>apps_not_in_prod</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>   <span style=color:#204a87>name</span>    <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#000>apps_not_in_prod</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#204a87>name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mongodb&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mongodb&#34;</span>              <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------+</span></code></pre></div><h2 id=modules>Modules</h2><p>In Rego, policies are defined inside <em>modules</em>. Modules consist of:</p><ul><li>Exactly one <a href=#packages>Package</a> declaration.</li><li>Zero or more <a href=#imports>Import</a> statements.</li><li>Zero or more <a href=#rules>Rule</a> definitions.</li></ul><p>Modules are typically represented in Unicode text and encoded in UTF-8.</p><h3 id=comments>Comments</h3><p>Comments begin with the <code>#</code> character and continue until the end of the line.</p><h3 id=packages>Packages</h3><p>Packages group the rules defined in one or more modules into a particular namespace. Because rules are namespaced they can be safely shared across projects.</p><p>Modules contributing to the same package do not have to be located in the same directory.</p><p>The rules defined in a module are automatically exported. That is, they can be queried under OPA’s <a href=../rest-api#data-api>Data API</a> provided the appropriate package is given. For example, given the following module:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span>

<span style=color:#000>pi</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>14159</span></code></pre></div><p>The <code>pi</code> document can be queried via the Data API:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#000>GET</span> <span style=color:#000>https://example.com/v1/data/opa/examples/pi</span> <span style=color:#204a87;font-weight:700>HTTP</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#0000cf;font-weight:700>1.1</span></code></pre></div><h3 id=imports>Imports</h3><p>Import statements declare dependencies that modules have on documents defined outside the package. By importing a document, the identifiers exported by that document can be referenced within the current module.</p><p>All modules contain implicit statements which import the <code>data</code> and <code>input</code> documents.</p><p>Modules use the same syntax to declare dependencies on <a href=../how-does-opa-work#base-documents>Base Documents</a> and <a href=../how-does-opa-work#rules-and-virtual-documents>Virtual Documents</a>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span>

<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span>

<span style=color:#000>http_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protocols</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;http&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Similarly, modules can declare dependencies on query arguments by specifying an import path that starts with <code>input</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span>

<span style=color:#000>import</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span>
<span style=color:#000>import</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span>

<span style=color:#8f5902;font-style:italic># allow alice to perform any operation.</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;alice&#34;</span> <span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># allow bob to perform read-only operations.</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;bob&#34;</span>
    <span style=color:#204a87>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;GET&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># allows users assigned a &#34;dev&#34; role to perform read-only operations.</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;GET&#34;</span>
    <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Imports can include an optional <code>as</code> keyword to handle namespacing issues:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span>

<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span> <span style=color:#000>as</span> <span style=color:#000>my_servers</span>

<span style=color:#000>http_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>server</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>my_servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>server</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>protocols</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;http&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><h2 id=with-keyword>With Keyword</h2><p>The <code>with</code> keyword allows queries to programmatically specify values nested
under the <a href=../how-does-opa-work#the-input-document>input Document</a> and the <a href=../how-does-opa-work#the-data-document>data Document</a>.</p><p>For example, given the simple authorization policy in the <a href=#imports>Imports</a>
section, we can write a query that checks whether a particular request would be
allowed:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>examples</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>allow</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allow</span> <span style=color:#000>with</span> <span style=color:#000>input</span> <span style=color:#000>as</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;alice&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;POST&#34;</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>true</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allow</span> <span style=color:#000>with</span> <span style=color:#000>input</span> <span style=color:#000>as</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;bob&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;GET&#34;</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>true</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>allow</span> <span style=color:#000>with</span> <span style=color:#000>input</span> <span style=color:#000>as</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;bob&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;DELETE&#34;</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>true</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allow</span> <span style=color:#000>with</span> <span style=color:#000>input</span> <span style=color:#000>as</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;charlie&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;GET&#34;</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000>with</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>roles</span> <span style=color:#000>as</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;charlie&#34;</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>true</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>allow</span> <span style=color:#000>with</span> <span style=color:#000>input</span> <span style=color:#000>as</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;charlie&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;method&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;GET&#34;</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000>with</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>roles</span> <span style=color:#000>as</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;bob&#34;</span><span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>true</span></code></pre></div><p>The <code>with</code> keyword acts as a modifier on expressions. A single expression is
allowed to have zero or more <code>with</code> modifiers. The <code>with</code> keyword has the
following syntax:</p><pre><code>&lt;expr&gt; with &lt;target-1&gt; as &lt;value-1&gt; [with &lt;target-2&gt; as &lt;value-2&gt; [...]]
</code></pre><p>The <code>&lt;target&gt;</code>s must be references to values in the input document (or the input
document itself) or data document.</p><h2 id=default-keyword>Default Keyword</h2><p>The <code>default</code> keyword allows policies to define a default value for documents
produced by rules with <a href=#complete-definitions>Complete Definitions</a>. The
default value is used when all of the rules sharing the same name are undefined.</p><p>For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>default</span> <span style=color:#000>allow</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>

<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;bob&#34;</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;GET&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;alice&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>When the <code>allow</code> document is queried, the return value will be either <code>true</code> or <code>false</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>allow</span> <span style=color:#000>with</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#000>as</span> <span style=color:#4e9a06>&#34;bob&#34;</span> <span style=color:#000>with</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#000>as</span> <span style=color:#4e9a06>&#34;POST&#34;</span>
<span style=color:#204a87;font-weight:700>false</span></code></pre></div><p>Without the default definition, the <code>allow</code> document would simply be undefined for the same input.</p><p>When the <code>default</code> keyword is used, the rule syntax is restricted to:</p><pre><code>default &lt;name&gt; = &lt;term&gt;
</code></pre><p>The term may be any scalar, composite, or comprehension value but it may not be
a variable or reference. If the value is a composite then it may not contain
variables or references.</p><h2 id=else-keyword>Else Keyword</h2><p>The <code>else</code> keyword is a basic control flow construct that gives you control
over rule evaluation order.</p><p>Rules grouped together with the <code>else</code> keyword are evaluated until a match is
found. Once a match is found, rule evaluation does not proceed to rules further
in the chain.</p><p>The <code>else</code> keyword is useful if you are porting policies into Rego from an
order-sensitive system like IPTables.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>authorize</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;allow&#34;</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;superuser&#34;</span>           <span style=color:#8f5902;font-style:italic># allow &#39;superuser&#39; to perform any operation.</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;deny&#34;</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;admin&#34;</span>            <span style=color:#8f5902;font-style:italic># disallow &#39;admin&#39; operations...</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>source_network</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;external&#34;</span>  <span style=color:#8f5902;font-style:italic># from external networks.</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic># ... more rules</span></code></pre></div><p>In the example below, evaluation stops immediately after the first rule even
though the input matches the second rule as well.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>input</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#4e9a06>&#34;exec_shell&#34;</span>
  <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;source_network&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;external&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;superuser&#34;</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>authorize</span>
<span style=color:#4e9a06>&#34;allow&#34;</span></code></pre></div><p>In the next example, the input matches the second rule (but not the first) so
evaluation continues to the second rule before stopping.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>input</span>
<span style=color:#000;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;path&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#4e9a06>&#34;exec_shell&#34;</span>
  <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;source_network&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;external&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;alice&#34;</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>authorize</span>
<span style=color:#4e9a06>&#34;deny&#34;</span></code></pre></div><p>The <code>else</code> keyword may be used repeatedly on the same rule and there is no
limit imposed on the number of <code>else</code> clauses on a rule.</p><h2 id=operators>Operators</h2><h3 id=equality-assignment-comparison-and-unification>Equality: Assignment, Comparison, and Unification</h3><p>Rego supports three kinds of equality: assignment (<code>:=</code>), comparison (<code>==</code>), and unification <code>=</code>. Both assignment (<code>:=</code>) and comparison (<code>==</code>) are only available inside of rules (and in the REPL), and we recommend using them whenever possible for policies that are easier to read and write.</p><h4 id=assignment>Assignment <code>:=</code></h4><p>The assignment operator (<code>:=</code>) is used to define local variables inside of a rule. Assigned variables are locally scoped to that rule and shadow global variables.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>example</span>

<span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100</span>

<span style=color:#204a87>p</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>     <span style=color:#8f5902;font-style:italic># declare local variable &#39;x&#39; and assign value 1</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>100</span>   <span style=color:#8f5902;font-style:italic># true because &#39;x&#39; refers to local variable</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>Assigned variables are not allowed to appear before the assignment in the
query. For example, the following policy will not compile:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>example</span>

<span style=color:#204a87>p</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>100</span>
    <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>     <span style=color:#8f5902;font-style:italic># error because x appears earlier in the query.</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>q</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
    <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span>     <span style=color:#8f5902;font-style:italic># error because x is assigned twice.</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><h4 id=comparison>Comparison <code>==</code></h4><p>Comparison checks if two values are equal within a rule. If the left or right hand side contains a variable that has not been assigned a value, the compiler throws an error.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>example</span>

<span style=color:#204a87>p</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100</span>
    <span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>100</span>   <span style=color:#8f5902;font-style:italic># true because x refers to the local variable</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>100</span>
<span style=color:#000>q</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>100</span>   <span style=color:#8f5902;font-style:italic># true because x refers to the global variable</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>r</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>z</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>100</span>   <span style=color:#8f5902;font-style:italic># compiler error because y has not been assigned a value</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><h4 id=unification>Unification <code>=</code></h4><p>Unification (<code>=</code>) combines assignment and comparison. Rego will assign variables to values that make the comparison true. Unification lets you ask for values for variables that make an expression true.</p><pre><code># Find values for x and y that make the equality true
&gt; [x, &quot;world&quot;] = [&quot;hello&quot;, y]
+---------+---------+
|    x    |    y    |
+---------+---------+
| &quot;hello&quot; | &quot;world&quot; |
+---------+---------+
</code></pre><pre><code># Find values for i, j, k, m that where the site server
#    name is the same as the app server name
&gt; sites[i].servers[j].name = apps[k].servers[m]
+---+---+---+---+
| i | j | k | m |
+---+---+---+---+
| 0 | 0 | 0 | 0 |
| 0 | 1 | 0 | 1 |
| 0 | 2 | 1 | 0 |
| 1 | 0 | 0 | 2 |
| 1 | 1 | 0 | 3 |
| 1 | 2 | 1 | 1 |
| 2 | 0 | 0 | 4 |
| 2 | 1 | 2 | 0 |
+---+---+---+---+
</code></pre><h4 id=best-practices-for-equality>Best Practices for Equality</h4><p>Here is a comparison of the three forms of equality.</p><pre><code>Equality  Applicable    Compiler Errors            Use Case
--------  -----------   -------------------------  ----------------------
:=        Inside rule   Var already assigned       Assign local variable
==        Inside rule   Var not assigned           Compare values
=         Everywhere    Values cannot be computed  Express query
</code></pre><p>Best practice is to use assignment <code>:=</code> and comparison <code>==</code> wherever possible. The additional compiler checks help avoid errors when writing policy, and the additional syntax helps make the intent clearer when reading policy.</p><p>Under the hood <code>:=</code> and <code>==</code> are syntactic sugar for <code>=</code>, local variable creation, and additional compiler checks.</p><h3 id=comparison-operators>Comparison Operators</h3><p>The following comparison operators are supported:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>a</span>  <span style=color:#ce5c00;font-weight:700>==</span>  <span style=color:#000>b</span>  <span style=color:#8f5902;font-style:italic>#  `a` is equal to `b`.</span>
<span style=color:#000>a</span>  <span style=color:#ce5c00;font-weight:700>!=</span>  <span style=color:#000>b</span>  <span style=color:#8f5902;font-style:italic>#  `a` is not equal to `b`.</span>
<span style=color:#000>a</span>  <span style=color:#ce5c00;font-weight:700>&lt;</span>   <span style=color:#000>b</span>  <span style=color:#8f5902;font-style:italic>#  `a` is less than `b`.</span>
<span style=color:#000>a</span>  <span style=color:#ce5c00;font-weight:700>&lt;=</span>  <span style=color:#000>b</span>  <span style=color:#8f5902;font-style:italic>#  `a` is less than or equal to `b`.</span>
<span style=color:#000>a</span>  <span style=color:#ce5c00;font-weight:700>&gt;</span>   <span style=color:#000>b</span>  <span style=color:#8f5902;font-style:italic>#  `a` is greater than `b`.</span>
<span style=color:#000>a</span>  <span style=color:#ce5c00;font-weight:700>&gt;=</span>  <span style=color:#000>b</span>  <span style=color:#8f5902;font-style:italic>#  `a` is greater than or equal to `b`.</span></code></pre></div><p>None of these operators bind variables contained
in the expression. As a result, if either operand is a variable, the variable
must appear in another expression in the same rule that would cause the
variable to be bound, i.e., an equality expression or the target position of
a built-in function.</p><h2 id=built-in-functions>Built-in Functions</h2><p>In some cases, rules must perform simple arithmetic, aggregation, and so on.
Rego provides a number of built-in functions (or “built-ins”) for performing
these tasks.</p><p>Built-ins can be easily recognized by their syntax. All built-ins have the
following form:</p><pre><code>&lt;name&gt;(&lt;arg-1&gt;, &lt;arg-2&gt;, ..., &lt;arg-n&gt;)
</code></pre><p>Built-ins usually take one or more input values and produce one output
value. Unless stated otherwise, all built-ins accept values or variables as
output arguments.</p><p>If a built-in function is invoked with a variable as input, the variable must
be <em>safe</em>, i.e., it must be assigned elsewhere in the query.</p><p>Built-ins can include &ldquo;.&rdquo; characters in the name. This allows them to be
namespaced. If you are adding custom built-ins to OPA, consider namespacing
them to avoid naming conflicts, e.g., <code>org.example.special_func</code>.</p><p>See the <a href=../language-reference#built-in-functions>Language Reference</a> document for
details on each built-in function.</p><h2 id=example-data>Example Data</h2><p>The rules below define the content of documents describing a simplistic deployment environment. These documents are referenced in other sections above.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>sites</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;region&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;east&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;prod&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;web-0&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;hydrogen&#34;</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;web-1&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;helium&#34;</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;db-0&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;lithium&#34;</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;region&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;west&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;smoke&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;web-1000&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;beryllium&#34;</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;web-1001&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;boron&#34;</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;db-1000&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;carbon&#34;</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;region&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;west&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;dev&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;web-dev&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;nitrogen&#34;</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#000;font-weight:700>{</span>
                <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;db-dev&#34;</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#4e9a06>&#34;hostname&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;oxygen&#34;</span>
            <span style=color:#000;font-weight:700>}</span>
        <span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#000>apps</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web-0&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;web-1&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;web-1000&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;web-1001&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;web-dev&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;mysql&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;db-0&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;db-1000&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;mongodb&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;servers&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;db-dev&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>]</span>

<span style=color:#000>containers</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;image&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;redis&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;ipaddress&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;10.0.0.1&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;big_stallman&#34;</span>
    <span style=color:#000;font-weight:700>},</span>
    <span style=color:#000;font-weight:700>{</span>
        <span style=color:#4e9a06>&#34;image&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;nginx&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;ipaddress&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;10.0.0.2&#34;</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#4e9a06>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;cranky_euclid&#34;</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>]</span></code></pre></div></div></section></div></article></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js></script><script src=/js/app.145c7a3bc61d0b561cc282851776ffdcd33e6b35aebca1b05449aa9195eaf751.js integrity="sha256-FFx6O8YdC1YcwoKFF3b/3NM&#43;azWuvKGwVEmqkZXq91E="></script></body></html>