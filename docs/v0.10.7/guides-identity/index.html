<!doctype html><html lang=en><head><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-84550302-1','auto');ga('send','pageview');</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=description content="Policy-based control for cloud native environments"><meta property=og:title content="Guides: Identity and User Attributes"><meta property=og:type content=documentation><meta property=og:url content=https://openpolicyagent.org/docs/v0.10.7/guides-identity/><meta property=og:locale content=en_US><meta property=og:site_name content="Open Policy Agent"><meta property=og:description content="Policy-based control for cloud native environments"><meta name=og:type content=article><meta name=og:image content=https://openpolicyagent.org/img/logos/opa-horizontal-color.png><meta name=og:image:alt content="Open Policy Agent project logo"><meta name=og:image:type content=image/png><meta name=twitter:card content=summary><meta name=twitter:site content=@OpenPolicyAgent><meta name=twitter:creator content=@OpenPolicyAgent><link rel=canonical content=https://openpolicyagent.org/docs/v0.10.7/guides-identity/><link rel="shortcut icon" href=/favicon.png type=image/x-icon><meta name=generator content="Hugo 0.53"><title>Open Policy Agent | Guides: Identity and User Attributes</title><link rel=stylesheet href=/css/style.6bbca25e01250b8412df90aabdfbddb4f7b3b892dd593d933cd29794b98a3373.css integrity="sha256-a7yiXgElC4QS35CqvfvdtPezuJLdWT2TPNKXlLmKM3M="></head><body><div class=dashboard><div class="dashboard-panel left has-background-white-bis is-hidden-mobile"><div class="dashboard-panel-header has-text-centered"><div class=dashboard-panel-header-logo><a href=https://openpolicyagent.org><img src=/img/logos/opa-stacked-color.png></a></div><div class="dropdown is-left"><div class=dropdown-trigger><span class="button is-primary"><span><strong>v0.10.7</strong>
<span class="tag latest-tag is-success is-small has-text-weight-bold">latest</span></span></span></div></div></div><div class="dashboard-panel-content is-scrollable"><div class=docs-nav><span class=docs-nav-title>Documentation</span>
<a class=docs-nav-item href=/docs/v0.10.7/>Introduction</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=docs-nav-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=docs-nav-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=docs-nav-item href=/docs/v0.10.7/status/>Status</a>
<a class=docs-nav-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=docs-nav-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=docs-nav-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=docs-nav-item href=/docs/v0.10.7/security/>Security</a>
<a class=docs-nav-item href=/docs/v0.10.7/plugins/>Plugins</a>
<a class=docs-nav-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=docs-nav-item href=/docs/v0.10.7/faq/>FAQ</a>
<a class=docs-nav-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><hr class=docs-nav-hr><span class=docs-nav-title>Tutorials</span>
<a class=docs-nav-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=docs-nav-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=docs-nav-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=docs-nav-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><hr class=docs-nav-hr><span class=docs-nav-title>Guides</span>
<a class="docs-nav-item is-active" href=/docs/v0.10.7/guides-identity/>Identity and User Attributes</a><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#jwt-tokens>JWT Tokens</a><ul><li><a href=#flow>Flow</a></li><li><a href=#updates>Updates</a></li><li><a href=#size-limitations>Size Limitations</a></li><li><a href=#security>Security</a></li></ul></li><li><a href=#downloading-ldap-ad-data-using-the-bundle-api>Downloading LDAP/AD data using the Bundle API</a><ul><li><a href=#flow-1>Flow</a></li><li><a href=#updates-1>Updates</a></li><li><a href=#size-limitations-1>Size limitations</a></li></ul></li><li><a href=#pushing-ldap-ad-into-opa>Pushing LDAP/AD into OPA</a><ul><li><a href=#flow-2>Flow</a></li><li><a href=#updates-2>Updates</a></li><li><a href=#size-limitations-2>Size limitations</a></li></ul></li><li><a href=#pull-from-ldap-ad-during-evaluation>Pull from LDAP/AD during evaluation</a><ul><li><a href=#current-limitations>Current limitations</a></li><li><a href=#flow-3>Flow</a></li><li><a href=#updates-3>Updates</a></li><li><a href=#size-limitations-3>Size limitations</a></li><li><a href=#performance-and-availability>Performance and Availability</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></li></ul></nav></div><a class=docs-nav-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Kubernetes Admission Control</a></div></div></div><div class="dashboard-main is-scrollable"><nav class="navbar is-primary"><div class="navbar-brand is-hidden-tablet"><a class=navbar-item href=https://openpolicyagent.org><img src=/img/logos/opa-icon-white.png></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=mobile-menu><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div class="navbar-menu is-hidden-tablet" id=mobile-menu><div class=navbar-start><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Documentation</span>
<a class=navbar-item href=/docs/v0.10.7/>Introduction</a>
<a class=navbar-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=navbar-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=navbar-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=navbar-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=navbar-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=navbar-item href=/docs/v0.10.7/status/>Status</a>
<a class=navbar-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=navbar-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=navbar-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=navbar-item href=/docs/v0.10.7/security/>Security</a>
<a class=navbar-item href=/docs/v0.10.7/plugins/>Plugins (Experimental)</a>
<a class=navbar-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=navbar-item href=/docs/v0.10.7/faq/>Frequently Asked Questions</a>
<a class=navbar-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Tutorials</span>
<a class=navbar-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=navbar-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=navbar-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=navbar-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Guides</span>
<a class=navbar-item href=/docs/v0.10.7/guides-identity/>Guides: Identity and User Attributes</a>
<a class=navbar-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Guides: Kubernetes Admission Control</a></div><div class=navbar-end><div class=navbar-item><div class=buttons><a class="button is-primary" href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class="button is-primary" href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class="button is-primary" href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class="button is-primary" href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></div></div><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class=navbar-item href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class=navbar-item href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class=navbar-item href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></nav><article class=article><div class=container><section class=hero><div class=hero-body><p class="title is-size-1 is-size-2-mobile">Guides: Identity and User Attributes</p></div></section><section class=section><div class=content><p>A common question from OPA users is how to deal with identity and user attributes. The first thing to keep in mind is that <strong>OPA does not handle authentication</strong>. OPA does not help users prove they are who they say they are; it does not handle usernames and passwords, or issue TLS certificates. OPA assumes you have authentication in place and helps you with the step after that: authorization and policy&ndash;controlling who can do what.</p><p>Of course, identity and user attribute information is crucial to answering who can do what. In fact, whenever possible you should write policy in terms of user attributes (e.g. group membership) instead of individual users. Otherwise, policies become brittle and require updates every time an individual (or software system) joins or leaves the organization. For example, you might grant higher privileges to people in engineering and currently on-call; then independently you can modify people&rsquo;s attributes without having to change policy.</p><p>To evaluate policies written using user attributes, OPA needs a way to figure out what the appropriate user attributes for each decision it makes. Often those user attributes are stored in LDAP or ActiveDirectory (AD). This document describes best-practices for providing LDAP/AD information to OPA.</p><p>Below we detail different ways to make LDAP/AD information available to OPA. At the time of writing <strong>OPA does not have an LDAP connector</strong>, though check the <a href=https://www.openpolicyagent.org/docs/language-reference.html>Builtins page</a> for the latest information. The purpose of this document is to help you understand the options for you to integrate your user-attribute store with OPA.
You should prefer earlier options in the list to later options, but in the end the right choice depends on your situation.</p><h2 id=jwt-tokens>JWT Tokens</h2><p><a href=https://tools.ietf.org/html/rfc7519>JSON Web Tokens (JWTs)</a> allow you to securely transmit JSON data between software systems and are often produced during the authentication process. You can set up authentication so that when the user logs in you create a JWT with that user&rsquo;s LDAP/AD data. Then you hand that JWT to OPA and use OPA&rsquo;s specialized support for JWTs to extract the information you need to make a policy decision.</p><h3 id=flow>Flow</h3><p>The following diagram shows this process in more detail.</p><ol><li>User logs in to LDAP/AD</li><li>The user is given a JWT token encoding group membership and other user attributes that are stored in LDAP/AD</li><li>The user provides that JWT token to an OPA-enabled software system for authentication</li><li>The OPA-enabled software system includes that token as part of the usual <code>input</code> to OPA.</li><li>OPA decodes the JWT token and uses the contents to make policy decisions.</li></ol><figure class=figure><img src=/img/best-practice-identity-jwt.png width=60%><figcaption class=has-text-weight-light>JSON Web Token flow</figcaption></figure><h3 id=updates>Updates</h3><p>The JWT only gets refreshed when the user authenticates; how often that happens is up to the TTL included in the token. When LDAP/AD information changes, those changes will not be seen by OPA until the user authenticates and gets a new JWT.</p><h3 id=size-limitations>Size Limitations</h3><p>JWTs have a limited size in practice, so if your organization has too many user attributes you may not be able to fit all the required information into a JWT.</p><h3 id=security>Security</h3><ul><li>OPA includes primitives to verify the signature of JWT tokens.</li><li>OPA let&rsquo;s you check the TTL.</li><li>OPA has early support for making HTTP requests during evaluation, which could be used to check if a JWT has been revoked. Though if you&rsquo;re connecting to a remote system on every policy decision anyway, you should think about whether connecting to LDAP/AD directly is more appropriate (see below).</li></ul><h2 id=downloading-ldap-ad-data-using-the-bundle-api>Downloading LDAP/AD data using the Bundle API</h2><p>JWTs may not be available to you. Or perhaps your policies require information about a user other than the one performing the action that OPA is authorizing.</p><p>For example, suppose your policy says a resource&rsquo;s owner or anyone in the owner&rsquo;s group may modify that resource. When Alice tries to modify a resource she doesn&rsquo;t own, OPA would need to find the owner and check if Alice belongs to the same group as the owner. But if OPA only has Alice&rsquo;s JWT token, it does not know what groups the resource&rsquo;s owner belong to.</p><p>In any case, another option is to replicate LDAP/AD data in bulk into OPA. One way to do that is through OPA&rsquo;s bundle feature, which periodically downloads policy bundles from a centralized server. Those bundles can include data as well as policy. If you implement the centralized server, you can include LDAP/AD data within the bundle. Then every time OPA gets updated policies, it gets updated LDAP/AD data too. You would need to integrate LDAP/AD into your bundle server&ndash;OPA does not help with that, but once it is done, OPA will pull the data out of your bundle server.</p><h3 id=flow-1>Flow</h3><p>Two things happen independently with this kind of LDAP/AD integration.</p><ol><li>OPA downloads new policy bundles including LDAP/AD</li><li>OPA-enabled software system asks OPA for policy decisions</li></ol><figure class=figure><img src=/img/best-practice-identity-bundle.png width=80%><figcaption class=has-text-weight-light>Bundle flow</figcaption></figure><h3 id=updates-1>Updates</h3><p>The lag between an LDAP/AD update and OPA having the update is the sum of the lag for an update between LDAP/AD and the central server and the lag for an update between the central server an OPA. So if LDAP/AD updates every 5 minutes, and OPA pulls an update every 2 minutes, then the total maximum lag is 7 minutes. Unlike the JWT case, it is feasible that a user could perform an action requiring authorization on the OPA-enabled service before OPA has the appropriate LDAP/AD policy, but you can account for that when writing policy and reject any request when there is insufficient data.</p><h3 id=size-limitations-1>Size limitations</h3><p>Unlike the JWT case, where OPA only stores 1 user&rsquo;s LDAP/AD data at a time, when synchronizing LDAP/AD, OPA stores all users&rsquo; LDAP/AD data at once in memory. Obviously this can be a problem with large LDAP/AD stores. Because the centralized server handles both policy and data it could provide just the LDAP/AD data necessary for the policies.</p><h2 id=pushing-ldap-ad-into-opa>Pushing LDAP/AD into OPA</h2><p>Another way to replicate LDAP/AD data into OPA is to use OPA&rsquo;s API for injecting arbitrary JSON data. You can build a synchronizer that pulls information out of LDAP/AD and pushes that information in OPA through its API. This approach would be useful if you are not using the bundle API, or you need to optimize for update latency.</p><h3 id=flow-2>Flow</h3><p>Two things happen independently with this kind of LDAP/AD integration.</p><ol><li>Synchronizer keeps OPA up to date with LDAP/AD</li><li>OPA-enabled software system asks OPA for policy decisions</li></ol><figure class=figure><img src=/img/best-practice-identity-push.png width=80%><figcaption class=has-text-weight-light>Push flow</figcaption></figure><h3 id=updates-2>Updates</h3><p>The total lag between LDAP/AD being updated and OPA being updated is the sum of the lag for an update between LDAP/AD and the synchronizer plus the lag for an update between the synchronizer and OPA. Unlike the JWT case, it is feasible that a user could perform an action requiring authorization on the OPA-enabled service before OPA has the appropriate LDAP/AD policy, but you can account for that when writing policy and reject any request when there is insufficient data.</p><h3 id=size-limitations-2>Size limitations</h3><p>Unlike the JWT case, where OPA only stores 1 user&rsquo;s LDAP/AD data at a time, when synchronizing LDAP/AD, OPA stores all users&rsquo; LDAP/AD data at once in memory. Obviously this can be a problem with large LDAP/AD stores.</p><h2 id=pull-from-ldap-ad-during-evaluation>Pull from LDAP/AD during evaluation</h2><p>OPA has experimental capabilities for reaching out to external servers during evaluation. This functionality handles those cases where there is too much data to synchronize into OPA, JWTs are ineffective, or policy requires information that must be as up to date as possible.</p><p>That functionality is implemented as <a href=https://www.openpolicyagent.org/docs/>OPA builtins</a>. Check the docs for the latest instructions.</p><h3 id=current-limitations>Current limitations</h3><ul><li>Unit test framework does not allow you to mock out the results of builtin functions</li><li>Any credentials that are needed for the external service must be hardcoded into the policy.<ul><li>There has been discussion around adding a builtin that pulls information out of the environment so that OPA can be configured with credentials.</li></ul></li></ul><h3 id=flow-3>Flow</h3><p>The key difference here is that every decision requires contacting LDAP/AD. If that service or the network connection is slow or unavailable, OPA may not be able to return a decision.</p><ol><li>OPA-enabled service asks OPA for a decision</li><li>OPA during evaluation asks LDAP/AD for user attributes</li></ol><figure class=figure><img src=/img/best-practice-identity-remote.png width=80%><figcaption class=has-text-weight-light>Pull flow</figcaption></figure><h3 id=updates-3>Updates</h3><p>LDAP/AD data is perfectly fresh. There is no lag between an update to LDAP/AD and when OPA sees that update.</p><h3 id=size-limitations-3>Size limitations</h3><p>Only the data actually needed by the policy is pulled from LDAP/AD. There is no need for a synchronizer to figure out what data the policy will need before execution. It is possible to gather multiple users&rsquo; attributes</p><h3 id=performance-and-availability>Performance and Availability</h3><p>Latency and availability of decision-making are dependent on the network. This approach may still be superior to running OPA on a remote server entirely because a local OPA can make some decisions without going over the network&ndash;those decisions that do not require information from the remote LDAP/AD server.</p><h2 id=summary>Summary</h2><table><thead><tr><th>Approach</th><th>Perf/Avail</th><th>Notes</th></tr></thead><tbody><tr><td>JWT</td><td>High</td><td>Updates only when user logs back in</td></tr><tr><td>Bundle</td><td>High</td><td>Updates to policy/data at the same time. Size an issue.</td></tr><tr><td>Push</td><td>High</td><td>Control data refresh rate. Size an issue.</td></tr><tr><td>Pull during eval</td><td>Dependent on network</td><td>Perfectly up to date. No size limit.</td></tr></tbody></table></div></section></div></article></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js></script><script src=/js/app.145c7a3bc61d0b561cc282851776ffdcd33e6b35aebca1b05449aa9195eaf751.js integrity="sha256-FFx6O8YdC1YcwoKFF3b/3NM&#43;azWuvKGwVEmqkZXq91E="></script></body></html>