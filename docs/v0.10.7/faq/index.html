<!doctype html><html lang=en><head><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-84550302-1','auto');ga('send','pageview');</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=description content="Policy-based control for cloud native environments"><meta property=og:title content="Frequently Asked Questions"><meta property=og:type content=documentation><meta property=og:url content=https://openpolicyagent.org/docs/v0.10.7/faq/><meta property=og:locale content=en_US><meta property=og:site_name content="Open Policy Agent"><meta property=og:description content="Policy-based control for cloud native environments"><meta name=og:type content=article><meta name=og:image content=https://openpolicyagent.org/img/logos/opa-horizontal-color.png><meta name=og:image:alt content="Open Policy Agent project logo"><meta name=og:image:type content=image/png><meta name=twitter:card content=summary><meta name=twitter:site content=@OpenPolicyAgent><meta name=twitter:creator content=@OpenPolicyAgent><link rel=canonical content=https://openpolicyagent.org/docs/v0.10.7/faq/><link rel="shortcut icon" href=/favicon.png type=image/x-icon><meta name=generator content="Hugo 0.53"><title>Open Policy Agent | Frequently Asked Questions</title><link rel=stylesheet href=/css/style.6bbca25e01250b8412df90aabdfbddb4f7b3b892dd593d933cd29794b98a3373.css integrity="sha256-a7yiXgElC4QS35CqvfvdtPezuJLdWT2TPNKXlLmKM3M="></head><body><div class=dashboard><div class="dashboard-panel left has-background-white-bis is-hidden-mobile"><div class="dashboard-panel-header has-text-centered"><div class=dashboard-panel-header-logo><a href=https://openpolicyagent.org><img src=/img/logos/opa-stacked-color.png></a></div><div class="dropdown is-left"><div class=dropdown-trigger><span class="button is-primary"><span><strong>v0.10.7</strong>
<span class="tag latest-tag is-success is-small has-text-weight-bold">latest</span></span></span></div></div></div><div class="dashboard-panel-content is-scrollable"><div class=docs-nav><span class=docs-nav-title>Documentation</span>
<a class=docs-nav-item href=/docs/v0.10.7/>Introduction</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=docs-nav-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=docs-nav-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=docs-nav-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=docs-nav-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=docs-nav-item href=/docs/v0.10.7/status/>Status</a>
<a class=docs-nav-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=docs-nav-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=docs-nav-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=docs-nav-item href=/docs/v0.10.7/security/>Security</a>
<a class=docs-nav-item href=/docs/v0.10.7/plugins/>Plugins</a>
<a class=docs-nav-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class="docs-nav-item is-active" href=/docs/v0.10.7/faq/>FAQ</a><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#how-do-i-make-user-attributes-stored-in-ldap-ad-available-to-opa-for-making-decisions>How do I make user attributes stored in LDAP/AD available to OPA for making decisions?</a></li><li><a href=#conflict-resolution>How does OPA do conflict resolution?</a></li><li><a href=#statement-order>Does Statement Order Matter?</a></li><li><a href=#which-equality-operator-should-i-use>Which Equality Operator Should I Use?</a></li><li><a href=#collaboration-using-import>Collaboration Using Import</a></li><li><a href=#high-performance-policy-decisions>High Performance Policy Decisions</a></li><li><a href=#functions-versus-rules>Functions Versus Rules</a></li><li><a href=#safety>Safety</a></li><li><a href=#json-web-tokens-jwts>JSON Web Tokens (JWTs)</a></li></ul></li></ul></nav></div><a class=docs-nav-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><hr class=docs-nav-hr><span class=docs-nav-title>Tutorials</span>
<a class=docs-nav-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=docs-nav-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=docs-nav-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=docs-nav-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=docs-nav-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><hr class=docs-nav-hr><span class=docs-nav-title>Guides</span>
<a class=docs-nav-item href=/docs/v0.10.7/guides-identity/>Identity and User Attributes</a>
<a class=docs-nav-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Kubernetes Admission Control</a></div></div></div><div class="dashboard-main is-scrollable"><nav class="navbar is-primary"><div class="navbar-brand is-hidden-tablet"><a class=navbar-item href=https://openpolicyagent.org><img src=/img/logos/opa-icon-white.png></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=mobile-menu><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div class="navbar-menu is-hidden-tablet" id=mobile-menu><div class=navbar-start><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Documentation</span>
<a class=navbar-item href=/docs/v0.10.7/>Introduction</a>
<a class=navbar-item href=/docs/v0.10.7/how-does-opa-work/>How Does OPA Work?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-write-policies/>How Do I Write Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/how-do-i-test-policies/>How Do I Test Policies?</a>
<a class=navbar-item href=/docs/v0.10.7/language-reference/>Language Reference</a>
<a class=navbar-item href=/docs/v0.10.7/configuration/>Configuration Reference</a>
<a class=navbar-item href=/docs/v0.10.7/rest-api/>REST API</a>
<a class=navbar-item href=/docs/v0.10.7/deployments/>Deployments</a>
<a class=navbar-item href=/docs/v0.10.7/bundles/>Bundles</a>
<a class=navbar-item href=/docs/v0.10.7/status/>Status</a>
<a class=navbar-item href=/docs/v0.10.7/decision-logs/>Decision Logs</a>
<a class=navbar-item href=/docs/v0.10.7/monitoring/>Monitoring</a>
<a class=navbar-item href=/docs/v0.10.7/discovery/>Discovery</a>
<a class=navbar-item href=/docs/v0.10.7/security/>Security</a>
<a class=navbar-item href=/docs/v0.10.7/plugins/>Plugins (Experimental)</a>
<a class=navbar-item href=/docs/v0.10.7/comparison-to-other-systems/>Comparison to Other Systems</a>
<a class=navbar-item href=/docs/v0.10.7/faq/>Frequently Asked Questions</a>
<a class=navbar-item href=/docs/v0.10.7/rego-cheatsheet/>Rego Cheatsheet</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Tutorials</span>
<a class=navbar-item href=/docs/v0.10.7/get-started/>Get started</a>
<a class=navbar-item href=/docs/v0.10.7/docker-authorization/>Docker Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/http-api-authorization/>HTTP API Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/ssh-and-sudo-authorization/>SSH and sudo Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kafka-authorization/>Kafka Authorization</a>
<a class=navbar-item href=/docs/v0.10.7/kubernetes-admission-control/>Kubernetes Admission Control</a>
<a class=navbar-item href=/docs/v0.10.7/terraform/>Terraform Testing</a>
<a class=navbar-item href=/docs/v0.10.7/ceph-authorization/>Ceph Authorization</a><br><span class="navbar-item is-size-5 has-text-weight-light is-uppercase">Guides</span>
<a class=navbar-item href=/docs/v0.10.7/guides-identity/>Guides: Identity and User Attributes</a>
<a class=navbar-item href=/docs/v0.10.7/guides-kubernetes-admission-control/>Guides: Kubernetes Admission Control</a></div><div class=navbar-end><div class=navbar-item><div class=buttons><a class="button is-primary" href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class="button is-primary" href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class="button is-primary" href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class="button is-primary" href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></div></div><div class=navbar-menu><div class=navbar-end><a class=navbar-item href=https://github.com/open-policy-agent/opa target=_blank><span class="icon has-text-white-bis"><i class="fab fa-github"></i></span></a><a class=navbar-item href=https://twitter.com/OpenPolicyAgent target=_blank><span class="icon has-text-white-bis"><i class="fab fa-twitter"></i></span></a><a class=navbar-item href=https://blog.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-medium"></i></span></a><a class=navbar-item href=https://slack.openpolicyagent.org target=_blank><span class="icon has-text-white-bis"><i class="fab fa-slack"></i></span></a></div></div></nav><article class=article><div class=container><section class=hero><div class=hero-body><p class="title is-size-1 is-size-2-mobile">Frequently Asked Questions</p></div></section><section class=section><div class=content><h2 id=how-do-i-make-user-attributes-stored-in-ldap-ad-available-to-opa-for-making-decisions>How do I make user attributes stored in LDAP/AD available to OPA for making decisions?</h2><p><a href=../guides-identity>This best-practice guide</a> explains three options: JSON Web Tokens, synchronization with LDAP/AD, and calling into LDAP/AD during policy evaluation.</p><h2 id=conflict-resolution>How does OPA do conflict resolution?</h2><p>In Rego (OPA&rsquo;s policy language), you can write statements that both allow and
deny a request, such as</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>foo</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;alice&#34;</span> <span style=color:#000;font-weight:700>}</span>
<span style=color:#000>deny</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;alice&#34;</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>Neither <code>allow</code> nor <code>deny</code> are keywords in Rego so if you want to treat them
as contradictory, you control which one takes precedence explicitly. When you ask for
a policy decision from OPA, you specify both the policy name (<code>foo</code>) and the
virtual document that names the decision within foo. Typically in this scenario,
you create a virtual document called <code>authz</code> and define it so that <code>allow</code>
overrides <code>deny</code> or vice versa. Then when asking for a policy decision, you
ask for <code>foo/authz</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># deny everything by default</span>
<span style=color:#000>default</span> <span style=color:#000>authz</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>false</span>

<span style=color:#8f5902;font-style:italic># deny overrides allow</span>
<span style=color:#000>authz</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>allow</span>
    <span style=color:#204a87;font-weight:700>not</span> <span style=color:#000>deny</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>If instead you want to resolve conflicts using a first-match strategy (where
the first statement applicable makes the decision), see the FAQ entry on
<a href=#statement-order>statement order</a>.</p><h2 id=statement-order>Does Statement Order Matter?</h2><p>The order in which statements occur does not matter in Rego. Reorder any two statements
and the policy means exactly the same thing. For example, the following two statements
mean the same thing whichever order you write them in.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>ratelimit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;alice&#34;</span> <span style=color:#000;font-weight:700>}</span>
<span style=color:#000>ratelimit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>owner</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;bob&#34;</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>Sometimes, though, you want the statement order to matter. For example, you might put more specific statements before more general statements so that the more specific statements take precedence (e.g. for <a href=#conflict-resolution>conflict resolution</a>). Rego lets you do that using the <code>else</code> keyword. For example, if you want to make the first statement above take precedence, you would write the following Rego.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>ratelimit</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;alice&#34;</span>
<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>owner</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;bob&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><h2 id=which-equality-operator-should-i-use>Which Equality Operator Should I Use?</h2><p>Rego supports three kinds of equality: assignment (<code>:=</code>), comparison (<code>==</code>), and unification <code>=</code>. Both assignment (<code>:=</code>) and comparison (<code>==</code>) are only available inside of rules (and in the REPL), and we recommend using them whenever possible for policies that are easier to read and write.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># Assignment: declare local variable x and give it value 7</span>
<span style=color:#8f5902;font-style:italic># If x appears before this statement in the rule, compiler throws error.</span>
<span style=color:#000>x</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span>
<span style=color:#000>y</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;b&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;c&#34;</span><span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># Comparison: check if two values are the same.</span>
<span style=color:#8f5902;font-style:italic>#   Do not assign variables--variables must be &#34;safe&#34;.</span>
<span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>7</span>
<span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>y</span>
<span style=color:#000>y</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#ce5c00;font-weight:700>]]</span>

<span style=color:#8f5902;font-style:italic># Unification: assign variables to values that make the</span>
<span style=color:#8f5902;font-style:italic>#   equality true</span>
<span style=color:#8f5902;font-style:italic># Note: = is the only option outside of rule bodies</span>
<span style=color:#000>x</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7</span>               <span style=color:#8f5902;font-style:italic># causes x to be assigned 7</span>
<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>y</span><span style=color:#ce5c00;font-weight:700>]</span>     <span style=color:#8f5902;font-style:italic># x is assigned 3 and y is assigned 2</span></code></pre></div><h2 id=collaboration-using-import>Collaboration Using Import</h2><p>OPA lets multiple teams contribute independent policies that you can then combine to make an overall decision. Each team writes their policy in a separate <code>package</code>, then you write one more policy that imports all the teams policies and makes a decision.</p><p>For example, suppose there is a network team, a storage team, and a compute team. Suppose they each write their own policy:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>compute</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>network</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>storage</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#ce5c00;font-weight:700>...</span> <span style=color:#000;font-weight:700>}</span></code></pre></div><p>Now the cloud team, who is in charge of the overall decision, writes another policy that combines the decisions for each of the team policies. In the example below, all 3 teams must allow for the overall decision to be allowed.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>package</span> <span style=color:#000>main</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>compute</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>storage</span>
<span style=color:#000>import</span> <span style=color:#000>data</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>network</span>

<span style=color:#8f5902;font-style:italic># allow if all 3 teams allow</span>
<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>compute</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>allow</span>
    <span style=color:#000>storage</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>allow</span>
    <span style=color:#000>network</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>allow</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The cloud team could have a more sophisticated scheme for combining policies, e.g. using just the compute policy for compute-only resources or requiring the compute policy to allow the compute-relevant portions of resource. Remember that <code>allow</code> is not special&ndash;it is just another boolean that the policy author can use to make decisions.</p><h2 id=high-performance-policy-decisions>High Performance Policy Decisions</h2><p>For low-latency/high-performance use-cases, e.g. microservice API authorization, policy evaluation has a budget on the order of 1 millisecond. Not all use cases require that kind of performance, and OPA is powerful enough that you can write policies that take much longer than 1 millisecond to evaluate. But for high-performance use cases, there is a fragment of the policy language that has been engineered to evaluate quickly. Even as the size of the policies grow, the performance for this fragment can be nearly constant-time.</p><p><strong>Linear fragment</strong> The <em>linear fragment</em> of the language is all of those policies where evaluation amounts to walking over the policy once. This means there is no search required to make a policy decision. Any variables you use can be assigned at most one value.</p><p>For example, the following rule has one local variable <code>user</code>, and that variable can only be assigned one value. Intuitively, evaluating this rule requires checking each of the conditions in the body, and if there were N of these rules, evaluation would only require walking over each of them as well.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;GET&#34;</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;accounts&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>user</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p><strong>Use objects instead of arrays</strong>. One common mistake people make is using arrays when they could use objects. For example, below is an array of ID/first-name/last-names where ID is unique, and you&rsquo;re looking up the first-name/last-name given the ID.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># DO NOT DO THIS.</span>
<span style=color:#8f5902;font-style:italic># Array of objects where each object has a unique identifier</span>
<span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;a123&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;first&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;alice&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;last&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;smith&#34;</span><span style=color:#000;font-weight:700>},</span>
     <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;a456&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;first&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;bob&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;last&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;jones&#34;</span><span style=color:#000;font-weight:700>},</span>
     <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;a789&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;first&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;clarice&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;last&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;johnson&#34;</span><span style=color:#000;font-weight:700>}</span>
     <span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#8f5902;font-style:italic># search through all elements of the array to find the ID</span>
<span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;a789&#34;</span>
<span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>...</span></code></pre></div><p>Instead, use a dictionary where the key is the ID and the value is the first-name/last-name. Given the ID, you can lookup the name information directly.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># DO THIS INSTEAD OF THE ABOVE</span>
<span style=color:#8f5902;font-style:italic># Use object whose keys are the IDs for the objects.</span>
<span style=color:#8f5902;font-style:italic>#   Looking up an object given its ID requires NO search</span>
<span style=color:#000>d</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;a123&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;first&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;alice&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;last&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;smith&#34;</span><span style=color:#000;font-weight:700>},</span>
     <span style=color:#4e9a06>&#34;a456&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;first&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;bob&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;last&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;jones&#34;</span><span style=color:#000;font-weight:700>},</span>
     <span style=color:#4e9a06>&#34;a789&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;first&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;clarice&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;last&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;johnson&#34;</span><span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#8f5902;font-style:italic># no search required</span>
<span style=color:#000>d</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;a789&#34;</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>first</span> <span style=color:#ce5c00;font-weight:700>...</span></code></pre></div><p><strong>Use simple equality statements for indexing</strong>. The linear-time fragment ensures that the cost of evaluation is no larger than the size of the policy. OPA lets you write non-linear policies, because sometimes you need to, and because sometimes it&rsquo;s convenient. The blog on <a href=https://blog.openpolicyagent.org/partial-evaluation-162750eaf422>partial evaluation</a> describes one mechanism for converting non-linear policies into linear policies.</p><p>But as the size of the policy grows, the cost of evaluation grows with it. Sometimes the policy can grow large enough that even the linear-fragment fails to meet the performance budget.</p><p>In the linear fragment, OPA includes special algorithms that index rules efficiently, sometimes making evaluation constant-time, even as the policy grows. The indexer looks for simple equality statements, so the more simple equality checks that appear in rules, the more effective the indexer is, and the fewer rules actually need to be evaluated. Here is an example policy from the <a href=https://blog.openpolicyagent.org/optimizing-opa-rule-indexing-59f03f17caf3>rule-indexing blog</a> giving the details for these algorithms.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;GET&#34;</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;accounts&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>user</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;GET&#34;</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;accounts&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;report&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;admin&#34;</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#000>allow</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>method</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;POST&#34;</span>
  <span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;accounts&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
  <span style=color:#000>roles</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>input</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>user</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;admin&#34;</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p><strong>Key takeaways</strong></p><p>For high-performance use cases:</p><ul><li>Write your policies to minimize iteration and search.<ul><li>Use objects instead of arrays when you have a unique identifier for the elements of the array.</li><li>Consider <a href=https://blog.openpolicyagent.org/partial-evaluation-162750eaf422>partial-evaluation</a> to compile non-linear policies to linear policies.</li></ul></li><li>Write your policies with simple equality statements so that <a href=https://blog.openpolicyagent.org/optimizing-opa-rule-indexing-59f03f17caf3>rule-indexing</a> is effective.</li></ul><h2 id=functions-versus-rules>Functions Versus Rules</h2><p>Rego lets you factor out common logic in 2 different and complementary ways.</p><p>One is the <em>function</em>, which is conceptually identical to functions from most programming languages. It takes any input and returns any output. Importantly, a function can take infinitely many inputs, e.g. any string.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>trim_and_split</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>result</span> <span style=color:#000;font-weight:700>{</span>
     <span style=color:#000>t</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>trim</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34; &#34;</span><span style=color:#000;font-weight:700>)</span>
     <span style=color:#000>result</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87>split</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;.&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>The other way to factor out common logic is with a <em>rule</em>. Rules differ in that (i) they support automatic iteration and (ii) they are only defined for finitely many inputs. (Those obviously go hand-in-hand.) For example, you could define a rule that maps an application to the hostnames that app is running on:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app_name</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>hostnames</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>app</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>apps</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
    <span style=color:#000>app_name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span>
    <span style=color:#000>hostnames</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>hostname</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#204a87>name</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
                            <span style=color:#000>s</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>sites</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>].</span><span style=color:#000>servers</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
                            <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87>name</span>
                            <span style=color:#000>hostname</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>s</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>hostname</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000;font-weight:700>}</span></code></pre></div><p>And then we can iterate over all the key/value pairs of that app-to-hostname mapping (just like we could iterate over all key/value pairs of a hardcoded JSON object). You can also iterate over just the keys or just the values or you can look up the value for a key or lookup all the keys for a single value.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># iterate over all key/value pairs</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>    <span style=color:#000>app</span>    <span style=color:#ce5c00;font-weight:700>|</span>                <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>     <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;hydrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;helium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;beryllium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;boron&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;nitrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mysql&#34;</span>   <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;lithium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;carbon&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mongodb&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;oxygen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                           <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+------------------------------------------------------+</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># iterate over all values</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>                 <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span>                  <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+------------------------------------------------------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;hydrogen&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;helium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;beryllium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;boron&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;nitrogen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;lithium&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#34;carbon&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                 <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;oxygen&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>                                           <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+------------------------------------------------------+</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># iterate over all keys</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>x</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>_</span>
<span style=color:#ce5c00;font-weight:700>+-----------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>     <span style=color:#000>x</span>     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;web&#34;</span>     <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mysql&#34;</span>   <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mongodb&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+-----------+</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># lookup the value for key &#34;web&#34;</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;web&#34;</span><span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#ce5c00;font-weight:700>[</span>
  <span style=color:#4e9a06>&#34;hydrogen&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;helium&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;beryllium&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;boron&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;nitrogen&#34;</span>
<span style=color:#ce5c00;font-weight:700>]</span></code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># lookup keys where value includes &#34;lithium&#34;</span>
<span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>app_to_hostnames</span><span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>k</span><span style=color:#ce5c00;font-weight:700>][</span><span style=color:#000>_</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;lithium&#34;</span>
<span style=color:#ce5c00;font-weight:700>+---------+</span>
<span style=color:#ce5c00;font-weight:700>|</span>    <span style=color:#000>k</span>    <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---------+</span>
<span style=color:#ce5c00;font-weight:700>|</span> <span style=color:#4e9a06>&#34;mysql&#34;</span> <span style=color:#ce5c00;font-weight:700>|</span>
<span style=color:#ce5c00;font-weight:700>+---------+</span></code></pre></div><p>Obviously with the <code>trim_and_split</code> function we cannot ask for all the inputs/outputs since there are infinitely many. We can&rsquo;t provide 1 input and ask for all the other inputs that make the function return true, again, because there could be infinitely many. The only thing we can do with a function is provide it all the inputs and ask for the output.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#ce5c00;font-weight:700>&gt;</span> <span style=color:#000>trim_and_split</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;   foo.bar.baz  &#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>[</span>
  <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#4e9a06>&#34;baz&#34;</span>
<span style=color:#ce5c00;font-weight:700>]</span></code></pre></div><p>Functions allow you to factor out common logic that has infinitely-many input/output pairs; rules allow you to factor out common logic with finitely many input/outputs and allow you to iterate over them in the same way as native JSON objects.</p><p>To achieve automatic iteration, there is an additional syntactic requirement on a rule that is NOT present for a function: <code>safety</code>. See the FAQ entry on safety for technical details. Every rule must be <code>safe</code>, which guarantees that OPA can figure out a finite list of possible values for every variable in the body and head of a rule.</p><p>We recommend using rules where possible and using functions when rules do not work.</p><h2 id=safety>Safety</h2><p>The compiler will sometimes throw errors that say a rule is not <code>safe</code>. The goal of safety is to ensure that every rule has finitely many inputs/outputs. Safety ensures that every variable has finitely many possible values, so that OPA can iterate over them to find those values that make the rule true. Technically:</p><pre><code>Safety: every variable appearing in the head or in a builtin or inside a negation must appear in a non-negated, non-builtin expression in the body of the rule.
</code></pre><p>Examples:</p><pre><code># Unsafe: x in head does not appear in body.
#   There are infinitely many values that make p true
p[x] { q[y]; r[y] }

# Safe.  q and r are both rules
#   Both q and r are finite; therefore p is also finite.
p[x] = y { q[x]; r[y] }

# Unsafe: y appears inside a builtin (+) but not in the body.
#   y has infinitely many possible values; so too does x.
p[x] { x := y + 7 }

# Safe: the only values for y are those in q.
#   Since q is a rule and finite so is p finite.
p[x] { x := y + 7; q[y]}

# Unsafe: x appears inside a negation
#  If q is finite, all the x's not in q are infinite.
p[x] { not q[x] }

# Safe: x appears inside of r so p is no larger than r
#  Since r is finite, so too is p
p[x] { not q[x]; r[x] }
</code></pre><p>Safety has one implication about negation: you don&rsquo;t iterate over values NOT in a rule like <code>q</code>. Instead, you iterate over values in another rule like <code>r</code> and then use negation to CHECK whether if that value is NOT in <code>q</code>.</p><p>Embedded terms like <code>not p[q[_]]</code> sometimes produce difficult to decipher error messages. We recommend pulling the embedded terms out into the rule&ndash;the meaning is the same and often creates easier to read error messages:</p><pre><code>x := q[_]
not p[x]
</code></pre><h2 id=json-web-tokens-jwts>JSON Web Tokens (JWTs)</h2><p><a href=https://jwt.io/>JSON Web Tokens (JWTs)</a> are an industry standard for exchanging information between services. Often they are used to represent information about the users logged into a system. OPA has special-purpose code for dealing with JWTs.</p><p>All JWTs with OPA come in as strings. That string is a JSON Web Token encoded with JWS Compact Serialization. JWE and JWS JSON Serialization are not supported.</p><p>You can verify tokens are properly signed.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># RS256 signature</span>
<span style=color:#000>valid</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>jwt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>verify_rs256</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>certificate</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic># PS256 signature</span>
<span style=color:#000>valid</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>jwt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>verify_ps256</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>certificate</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic># ES256 signature</span>
<span style=color:#000>valid</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>jwt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>verify_es256</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>certificate</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic># HS256 signature</span>
<span style=color:#000>valid</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>jwt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>verify_hs256</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>certificate</span><span style=color:#000;font-weight:700>)</span></code></pre></div><p>You can decode JWTs and use the contents of the JWT to make policy decisions.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># If nested signing was used, the header, payload and signature will represent the most deeply nested token.</span>
<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>header</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>payload</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>signature</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>jwt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>decode</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#000;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic># Verify and decode, where constraints include cert, secret, the</span>
<span style=color:#8f5902;font-style:italic>#   algorithm name to use, and additional parameters for the verification</span>
<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#000>valid</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>header</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>payload</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>jwt</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>decode_verify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>constraints</span><span style=color:#000;font-weight:700>)</span></code></pre></div><p>For details see the <a href=https://www.openpolicyagent.org/docs/language-reference.html#tokens>language reference section on tokens</a>.</p><p>To get certificates into the policy, you can either hardcode them or provide them as environmental variables to OPA and then use the <code>opa.runtime</code> builtin to retrieve those variables.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#8f5902;font-style:italic># all runtime information</span>
<span style=color:#000>runtime</span> <span style=color:#000;font-weight:700>:</span><span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>opa</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>runtime</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#8f5902;font-style:italic># environment variables provided when OPA started</span>
<span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>env</span>
<span style=color:#8f5902;font-style:italic># the env variable PROD_CERTIFICATE</span>
<span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>env</span><span style=color:#ce5c00;font-weight:700>.</span><span style=color:#000>PROD_CERTIFICATE</span></code></pre></div></div></section></div></article></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js></script><script src=/js/app.145c7a3bc61d0b561cc282851776ffdcd33e6b35aebca1b05449aa9195eaf751.js integrity="sha256-FFx6O8YdC1YcwoKFF3b/3NM&#43;azWuvKGwVEmqkZXq91E="></script></body></html>